<!DOCTYPE html>
<html >
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <title>Hexo</title>
    <meta name="description" content="yolov3代码探究-5 utils.pygithub-yolov3utils.py 这边是重点中的重点了，如何计算loss和各种评价指标。按照我的优先级，先重点看loss计算的代码。（事实上花时间在这代码上有两天了，还是有很多问题） 1234567891011121314151617181920212223242526272829303132333435363738394041424344454">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/2020/02/04/deep_learning/yolo/yolov3%E4%BB%A3%E7%A0%81%E6%8E%A2%E7%A9%B6-5%20utils.py/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="yolov3代码探究-5 utils.pygithub-yolov3utils.py 这边是重点中的重点了，如何计算loss和各种评价指标。按照我的优先级，先重点看loss计算的代码。（事实上花时间在这代码上有两天了，还是有很多问题） 1234567891011121314151617181920212223242526272829303132333435363738394041424344454">
<meta property="og:locale">
<meta property="article:published_time" content="2020-02-04T05:26:23.000Z">
<meta property="article:modified_time" content="2020-02-04T05:26:23.000Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">

    
    <link rel="icon" href="https://i.loli.net/2021/03/04/Y8OtTdUnM4isHxh.jpg" type="image/x-icon">

    
<link rel="stylesheet" href="/css/common.min.css">



    
    
    
    
        <link href="//cdn.jsdelivr.net/npm/lightgallery.js@1.1.3/dist/css/lightgallery.min.css" rel="stylesheet">
    
    
    
<link rel="stylesheet" href="/css/iconfont.min.css">

    
<meta name="generator" content="Hexo 5.4.0"></head>

    <body>
        <header class="header header-fixture">
    <div class="profile-search-wrap flex sm:block">
        
        
        <div class="profile sm:text-center md:px-1 lg:px-3 sm:pb-4 sm:pt-6">
            <a id="avatar" role="link" href="https://github.com/grace-gu" class="inline-block lg:w-16 lg:h-16 w-8 h-8 m-2" target="_blank" rel="noopener" rel="noreferrer" >
                <img src="https://i.loli.net/2021/03/04/Y8OtTdUnM4isHxh.jpg" class="rounded-full" alt="avatar">
            </a>
            <h2 id="name" class="hidden lg:block">Grace</h2>
            <h3 id="title" class="hidden xl:block">coder</h3>
            
            <small id="location" class="hidden lg:block">
                <i class="iconfont icon-map-icon"></i>
                Beijing, China
            </small>
            
        </div>
        
        
<div class="search flex-1 flex lg:inline-block sm:hidden lg:px-4 lg:mt-2 lg:mb-4 lg:w-full">
    <form id="search-form" class="my-auto flex-1 lg:border lg:border-solid lg:border-gray-200">
        <div class="input-group table bg-gray-100 lg:bg-white w-full">
            <input id="search-input" type="text" placeholder="Search" class="inline-block w-full bg-gray-100 lg:bg-white">
            <span class="table-cell">
                <button name="search tigger button" disabled>
                    <i class="iconfont icon-search m-2"></i>
                </button>
            </span>
        </div>
    </form>
        
<script id="search-teamplate" type="text/html" data-path="/content.json">
    <div>
        <div class="search-header bg-gray-400">
            <input id="actual-search-input" model="keyword" ref="input" class="inline-block w-full h-10 px-2 py-1" placeholder="Search" type="text">
        </div>
        <div class="search-result bg-gray-200">
            {{#each searchPosts}}
            <a href="/{{ path }}" class="result-item block px-2 pb-3 mb-1 pt-1 hover:bg-indigo-100">
                <i class="iconfont icon-file"></i>
                <h1 class="result-title inline font-medium text-lg">{{ title }}</h1>
                <p class="result-content text-gray-600 text-sm">{{{ text }}}</p>
            </a>
            {{/each}}
        </div>
    </div>
</script>

</div>


        <button name="menu toogle button" id="menu-toggle-btn" class="block sm:hidden p-3" role="button" aria-expanded="false">
            <i class="iconfont icon-hamburger"></i>
        </button>
    </div>
    <nav id="menu-nav" class="hidden sm:flex flex-col">
        
        
            <div class="menu-item menu-home" role="menuitem">
                <a href="/.">
                    <i class="iconfont icon-home" aria-hidden="true"></i>
                    <span class="menu-title">Home</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-archives" role="menuitem">
                <a href="/archives">
                    <i class="iconfont icon-archive" aria-hidden="true"></i>
                    <span class="menu-title">Archives</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-categories" role="menuitem">
                <a href="/categories">
                    <i class="iconfont icon-folder" aria-hidden="true"></i>
                    <span class="menu-title">Categories</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-tags" role="menuitem">
                <a href="/tags">
                    <i class="iconfont icon-tag" aria-hidden="true"></i>
                    <span class="menu-title">Tags</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-repository" role="menuitem">
                <a href="/repository">
                    <i class="iconfont icon-project" aria-hidden="true"></i>
                    <span class="menu-title">Repository</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-links" role="menuitem">
                <a href="/links">
                    <i class="iconfont icon-friend" aria-hidden="true"></i>
                    <span class="menu-title">Links</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-about" role="menuitem">
                <a href="/about">
                    <i class="iconfont icon-cup" aria-hidden="true"></i>
                    <span class="menu-title">About</span>
                </a>
            </div>
        
        
<div class="social-links flex sm:flex-col lg:hidden mt-5">
    
        <span class="social-item text-center">
            <a target="_blank" rel="noopener" href="https://github.com/grac-gu">
                <i class="iconfont social-icon icon-github"></i>
                <span class="menu-title hidden lg:inline">menu.github</span>
            </a>
        </span>
    
        <span class="social-item text-center">
            <a href="/None">
                <i class="iconfont social-icon icon-telegram"></i>
                <span class="menu-title hidden lg:inline">menu.telegram</span>
            </a>
        </span>
    
        <span class="social-item text-center">
            <a href="/None">
                <i class="iconfont social-icon icon-twitter"></i>
                <span class="menu-title hidden lg:inline">menu.twitter</span>
            </a>
        </span>
    
        <span class="social-item text-center">
            <a href="/atom.xml">
                <i class="iconfont social-icon icon-rss"></i>
                <span class="menu-title hidden lg:inline">menu.rss</span>
            </a>
        </span>
    
</div>


    </nav>
</header>

        <section class="main-section">
            
    <main class="flex-1 px-4 py-12 md:px-5 lg:px-8 lg:py-4 relative min-h-screen">
    

    <article class="content article article-archives article-type-list" itemscope="">
        <header class="article-header">
            


            <p class="article-meta mb-3 text-xs">
                <span class="article-date">
    <i class="iconfont icon-calendar-check"></i>
	<a href="/2020/02/04/deep_learning/yolo/yolov3%E4%BB%A3%E7%A0%81%E6%8E%A2%E7%A9%B6-5%20utils.py/" class="article-date">
	  <time datetime="2020-02-04T05:26:23.000Z" itemprop="datePublished">Feb 4</time>
	</a>
</span>

                

                

                <span class="_partial/post-comment"><i class="icon icon-comment"></i>
                    <a href="/2020/02/04/deep_learning/yolo/yolov3%E4%BB%A3%E7%A0%81%E6%8E%A2%E7%A9%B6-5%20utils.py/#comments" class="article-comment-link">
                        Comments
                    </a>
                </span>
                

            </p>
        </header>
        <div class="marked-body article-body">
            <h1 id="yolov3代码探究-5-utils-py"><a href="#yolov3代码探究-5-utils-py" class="headerlink" title="yolov3代码探究-5 utils.py"></a>yolov3代码探究-5 utils.py</h1><p><a target="_blank" rel="noopener" href="https://github.com/ultralytics/yolov3">github-yolov3</a><br><a target="_blank" rel="noopener" href="https://github.com/ultralytics/yolov3/blob/master/train.py">utils.py</a></p>
<p>这边是重点中的重点了，如何计算loss和各种评价指标。<br>按照我的优先级，先重点看loss计算的代码。（事实上花时间在这代码上有两天了，还是有很多问题）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> matplotlib</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> torch_utils  <span class="comment"># , google_utils</span></span><br><span class="line"></span><br><span class="line">matplotlib.rc(<span class="string">&#x27;font&#x27;</span>, **&#123;<span class="string">&#x27;size&#x27;</span>: <span class="number">11</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set printoptions</span></span><br><span class="line">torch.set_printoptions(linewidth=<span class="number">1320</span>, precision=<span class="number">5</span>, profile=<span class="string">&#x27;long&#x27;</span>)</span><br><span class="line">np.set_printoptions(linewidth=<span class="number">320</span>, formatter=&#123;<span class="string">&#x27;float_kind&#x27;</span>: <span class="string">&#x27;&#123;:11.5g&#125;&#x27;</span>.<span class="built_in">format</span>&#125;)  <span class="comment"># format short g, %precision=5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Prevent OpenCV from multithreading (to use PyTorch DataLoader)</span></span><br><span class="line">cv2.setNumThreads(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">float3</span>(<span class="params">x</span>):</span>  <span class="comment"># format floats to 3 decimals</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">float</span>(<span class="built_in">format</span>(x, <span class="string">&#x27;.3f&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_seeds</span>(<span class="params">seed=<span class="number">0</span></span>):</span></span><br><span class="line">    random.seed(seed)</span><br><span class="line">    np.random.seed(seed)</span><br><span class="line">    torch_utils.init_seeds(seed=seed)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_classes</span>(<span class="params">path</span>):</span></span><br><span class="line">    <span class="comment"># Loads *.names file at &#x27;path&#x27;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        names = f.read().split(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="literal">None</span>, names))  <span class="comment"># filter removes empty strings (such as last line)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">model_info</span>(<span class="params">model, report=<span class="string">&#x27;summary&#x27;</span></span>):</span></span><br><span class="line">    <span class="comment"># Plots a line-by-line description of a PyTorch model</span></span><br><span class="line">    n_p = <span class="built_in">sum</span>(x.numel() <span class="keyword">for</span> x <span class="keyword">in</span> model.parameters())  <span class="comment"># number parameters</span></span><br><span class="line">    n_g = <span class="built_in">sum</span>(x.numel() <span class="keyword">for</span> x <span class="keyword">in</span> model.parameters() <span class="keyword">if</span> x.requires_grad)  <span class="comment"># number gradients</span></span><br><span class="line">    <span class="keyword">if</span> report <span class="keyword">is</span> <span class="string">&#x27;full&#x27;</span>:</span><br><span class="line">        print(<span class="string">&#x27;%5s %40s %9s %12s %20s %10s %10s&#x27;</span> % (<span class="string">&#x27;layer&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;gradient&#x27;</span>, <span class="string">&#x27;parameters&#x27;</span>, <span class="string">&#x27;shape&#x27;</span>, <span class="string">&#x27;mu&#x27;</span>, <span class="string">&#x27;sigma&#x27;</span>))</span><br><span class="line">        <span class="keyword">for</span> i, (name, p) <span class="keyword">in</span> <span class="built_in">enumerate</span>(model.named_parameters()):</span><br><span class="line">            name = name.replace(<span class="string">&#x27;module_list.&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            print(<span class="string">&#x27;%5g %40s %9s %12g %20s %10.3g %10.3g&#x27;</span> %</span><br><span class="line">                  (i, name, p.requires_grad, p.numel(), <span class="built_in">list</span>(p.shape), p.mean(), p.std()))</span><br><span class="line">    print(<span class="string">&#x27;Model Summary: %g layers, %g parameters, %g gradients&#x27;</span> % (<span class="built_in">len</span>(<span class="built_in">list</span>(model.parameters())), n_p, n_g))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">labels_to_class_weights</span>(<span class="params">labels, nc=<span class="number">80</span></span>):</span></span><br><span class="line">    <span class="comment"># Get class weights (inverse frequency) from training labels</span></span><br><span class="line">    labels = np.concatenate(labels, <span class="number">0</span>)  <span class="comment"># labels.shape = (866643, 5) for COCO</span></span><br><span class="line">    classes = labels[:, <span class="number">0</span>].astype(np.<span class="built_in">int</span>)  <span class="comment"># labels = [class xywh]</span></span><br><span class="line">    weights = np.bincount(classes, minlength=nc)  <span class="comment"># occurences per class</span></span><br><span class="line">    weights[weights == <span class="number">0</span>] = <span class="number">1</span>  <span class="comment"># replace empty bins with 1</span></span><br><span class="line">    weights = <span class="number">1</span> / weights  <span class="comment"># number of targets per class</span></span><br><span class="line">    weights /= weights.<span class="built_in">sum</span>()  <span class="comment"># normalize</span></span><br><span class="line">    <span class="keyword">return</span> torch.Tensor(weights)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">labels_to_image_weights</span>(<span class="params">labels, nc=<span class="number">80</span>, class_weights=np.ones(<span class="params"><span class="number">80</span></span>)</span>):</span></span><br><span class="line">    <span class="comment"># Produces image weights based on class mAPs</span></span><br><span class="line">    n = <span class="built_in">len</span>(labels)</span><br><span class="line">    class_counts = np.array([np.bincount(labels[i][:, <span class="number">0</span>].astype(np.<span class="built_in">int</span>), minlength=nc) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n)])</span><br><span class="line">    image_weights = (class_weights.reshape(<span class="number">1</span>, nc) * class_counts).<span class="built_in">sum</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># index = random.choices(range(n), weights=image_weights, k=1)  # weight image sample</span></span><br><span class="line">    <span class="keyword">return</span> image_weights</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">coco_class_weights</span>():</span>  <span class="comment"># frequency of each class in coco train2014</span></span><br><span class="line">    n = [<span class="number">187437</span>, <span class="number">4955</span>, <span class="number">30920</span>, <span class="number">6033</span>, <span class="number">3838</span>, <span class="number">4332</span>, <span class="number">3160</span>, <span class="number">7051</span>, <span class="number">7677</span>, <span class="number">9167</span>, <span class="number">1316</span>, <span class="number">1372</span>, <span class="number">833</span>, <span class="number">6757</span>, <span class="number">7355</span>, <span class="number">3302</span>, <span class="number">3776</span>, <span class="number">4671</span>,</span><br><span class="line">         <span class="number">6769</span>, <span class="number">5706</span>, <span class="number">3908</span>, <span class="number">903</span>, <span class="number">3686</span>, <span class="number">3596</span>, <span class="number">6200</span>, <span class="number">7920</span>, <span class="number">8779</span>, <span class="number">4505</span>, <span class="number">4272</span>, <span class="number">1862</span>, <span class="number">4698</span>, <span class="number">1962</span>, <span class="number">4403</span>, <span class="number">6659</span>, <span class="number">2402</span>, <span class="number">2689</span>,</span><br><span class="line">         <span class="number">4012</span>, <span class="number">4175</span>, <span class="number">3411</span>, <span class="number">17048</span>, <span class="number">5637</span>, <span class="number">14553</span>, <span class="number">3923</span>, <span class="number">5539</span>, <span class="number">4289</span>, <span class="number">10084</span>, <span class="number">7018</span>, <span class="number">4314</span>, <span class="number">3099</span>, <span class="number">4638</span>, <span class="number">4939</span>, <span class="number">5543</span>, <span class="number">2038</span>, <span class="number">4004</span>,</span><br><span class="line">         <span class="number">5053</span>, <span class="number">4578</span>, <span class="number">27292</span>, <span class="number">4113</span>, <span class="number">5931</span>, <span class="number">2905</span>, <span class="number">11174</span>, <span class="number">2873</span>, <span class="number">4036</span>, <span class="number">3415</span>, <span class="number">1517</span>, <span class="number">4122</span>, <span class="number">1980</span>, <span class="number">4464</span>, <span class="number">1190</span>, <span class="number">2302</span>, <span class="number">156</span>, <span class="number">3933</span>,</span><br><span class="line">         <span class="number">1877</span>, <span class="number">17630</span>, <span class="number">4337</span>, <span class="number">4624</span>, <span class="number">1075</span>, <span class="number">3468</span>, <span class="number">135</span>, <span class="number">1380</span>]</span><br><span class="line">    weights = <span class="number">1</span> / torch.Tensor(n)</span><br><span class="line">    weights /= weights.<span class="built_in">sum</span>()</span><br><span class="line">    <span class="keyword">return</span> weights</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">coco80_to_coco91_class</span>():</span>  <span class="comment"># converts 80-index (val2014) to 91-index (paper)</span></span><br><span class="line">    <span class="comment"># https://tech.amikelive.com/node-718/what-object-categories-labels-are-in-coco-dataset/</span></span><br><span class="line">    <span class="comment"># a = np.loadtxt(&#x27;data/coco.names&#x27;, dtype=&#x27;str&#x27;, delimiter=&#x27;\n&#x27;)</span></span><br><span class="line">    <span class="comment"># b = np.loadtxt(&#x27;data/coco_paper.names&#x27;, dtype=&#x27;str&#x27;, delimiter=&#x27;\n&#x27;)</span></span><br><span class="line">    <span class="comment"># x = [list(a[i] == b).index(True) + 1 for i in range(80)]  # darknet to coco</span></span><br><span class="line">    x = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">21</span>, <span class="number">22</span>, <span class="number">23</span>, <span class="number">24</span>, <span class="number">25</span>, <span class="number">27</span>, <span class="number">28</span>, <span class="number">31</span>, <span class="number">32</span>, <span class="number">33</span>, <span class="number">34</span>,</span><br><span class="line">         <span class="number">35</span>, <span class="number">36</span>, <span class="number">37</span>, <span class="number">38</span>, <span class="number">39</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">42</span>, <span class="number">43</span>, <span class="number">44</span>, <span class="number">46</span>, <span class="number">47</span>, <span class="number">48</span>, <span class="number">49</span>, <span class="number">50</span>, <span class="number">51</span>, <span class="number">52</span>, <span class="number">53</span>, <span class="number">54</span>, <span class="number">55</span>, <span class="number">56</span>, <span class="number">57</span>, <span class="number">58</span>, <span class="number">59</span>, <span class="number">60</span>, <span class="number">61</span>, <span class="number">62</span>, <span class="number">63</span>,</span><br><span class="line">         <span class="number">64</span>, <span class="number">65</span>, <span class="number">67</span>, <span class="number">70</span>, <span class="number">72</span>, <span class="number">73</span>, <span class="number">74</span>, <span class="number">75</span>, <span class="number">76</span>, <span class="number">77</span>, <span class="number">78</span>, <span class="number">79</span>, <span class="number">80</span>, <span class="number">81</span>, <span class="number">82</span>, <span class="number">84</span>, <span class="number">85</span>, <span class="number">86</span>, <span class="number">87</span>, <span class="number">88</span>, <span class="number">89</span>, <span class="number">90</span>]</span><br><span class="line">    <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure>
<p>&nbsp;<br>有教学意义的教你如何网络初始化，但其实作者没用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">weights_init_normal</span>(<span class="params">m</span>):</span></span><br><span class="line">    classname = m.__class__.__name__</span><br><span class="line">    <span class="keyword">if</span> classname.find(<span class="string">&#x27;Conv&#x27;</span>) != -<span class="number">1</span>:</span><br><span class="line">        torch.nn.init.normal_(m.weight.data, <span class="number">0.0</span>, <span class="number">0.03</span>)</span><br><span class="line">    <span class="keyword">elif</span> classname.find(<span class="string">&#x27;BatchNorm2d&#x27;</span>) != -<span class="number">1</span>:</span><br><span class="line">        torch.nn.init.normal_(m.weight.data, <span class="number">1.0</span>, <span class="number">0.03</span>)</span><br><span class="line">        torch.nn.init.constant_(m.bias.data, <span class="number">0.0</span>)</span><br></pre></td></tr></table></figure>

<p>&nbsp;<br>一些常用的函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xyxy2xywh</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="comment"># Convert bounding box format from [x1, y1, x2, y2] to [x, y, w, h]</span></span><br><span class="line">    y = torch.zeros_like(x) <span class="keyword">if</span> <span class="built_in">isinstance</span>(x, torch.Tensor) <span class="keyword">else</span> np.zeros_like(x)</span><br><span class="line">    y[:, <span class="number">0</span>] = (x[:, <span class="number">0</span>] + x[:, <span class="number">2</span>]) / <span class="number">2</span></span><br><span class="line">    y[:, <span class="number">1</span>] = (x[:, <span class="number">1</span>] + x[:, <span class="number">3</span>]) / <span class="number">2</span></span><br><span class="line">    y[:, <span class="number">2</span>] = x[:, <span class="number">2</span>] - x[:, <span class="number">0</span>]</span><br><span class="line">    y[:, <span class="number">3</span>] = x[:, <span class="number">3</span>] - x[:, <span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xywh2xyxy</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="comment"># Convert bounding box format from [x, y, w, h] to [x1, y1, x2, y2]</span></span><br><span class="line">    y = torch.zeros_like(x) <span class="keyword">if</span> <span class="built_in">isinstance</span>(x, torch.Tensor) <span class="keyword">else</span> np.zeros_like(x)</span><br><span class="line">    y[:, <span class="number">0</span>] = x[:, <span class="number">0</span>] - x[:, <span class="number">2</span>] / <span class="number">2</span></span><br><span class="line">    y[:, <span class="number">1</span>] = x[:, <span class="number">1</span>] - x[:, <span class="number">3</span>] / <span class="number">2</span></span><br><span class="line">    y[:, <span class="number">2</span>] = x[:, <span class="number">0</span>] + x[:, <span class="number">2</span>] / <span class="number">2</span></span><br><span class="line">    y[:, <span class="number">3</span>] = x[:, <span class="number">1</span>] + x[:, <span class="number">3</span>] / <span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> y</span><br></pre></td></tr></table></figure>

<p>&nbsp;<br>下面的代码暂时没用得上，没看</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scale_coords</span>(<span class="params">img1_shape, coords, img0_shape</span>):</span></span><br><span class="line">    <span class="comment"># Rescale coords (xyxy) from img1_shape to img0_shape</span></span><br><span class="line">    gain = <span class="built_in">max</span>(img1_shape) / <span class="built_in">max</span>(img0_shape)  <span class="comment"># gain  = old / new</span></span><br><span class="line">    coords[:, [<span class="number">0</span>, <span class="number">2</span>]] -= (img1_shape[<span class="number">1</span>] - img0_shape[<span class="number">1</span>] * gain) / <span class="number">2</span>  <span class="comment"># x padding</span></span><br><span class="line">    coords[:, [<span class="number">1</span>, <span class="number">3</span>]] -= (img1_shape[<span class="number">0</span>] - img0_shape[<span class="number">0</span>] * gain) / <span class="number">2</span>  <span class="comment"># y padding</span></span><br><span class="line">    coords[:, :<span class="number">4</span>] /= gain</span><br><span class="line">    clip_coords(coords, img0_shape)</span><br><span class="line">    <span class="keyword">return</span> coords</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clip_coords</span>(<span class="params">boxes, img_shape</span>):</span></span><br><span class="line">    <span class="comment"># Clip bounding xyxy bounding boxes to image shape (height, width)</span></span><br><span class="line">    boxes[:, [<span class="number">0</span>, <span class="number">2</span>]] = boxes[:, [<span class="number">0</span>, <span class="number">2</span>]].clamp(<span class="built_in">min</span>=<span class="number">0</span>, <span class="built_in">max</span>=img_shape[<span class="number">1</span>])  <span class="comment"># clip x</span></span><br><span class="line">    boxes[:, [<span class="number">1</span>, <span class="number">3</span>]] = boxes[:, [<span class="number">1</span>, <span class="number">3</span>]].clamp(<span class="built_in">min</span>=<span class="number">0</span>, <span class="built_in">max</span>=img_shape[<span class="number">0</span>])  <span class="comment"># clip y</span></span><br></pre></td></tr></table></figure>

<p>&nbsp;<br>要看还没看的关于计算mAP的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ap_per_class</span>(<span class="params">tp, conf, pred_cls, target_cls</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; Compute the average precision, given the recall and precision curves.</span></span><br><span class="line"><span class="string">    Source: https://github.com/rafaelpadilla/Object-Detection-Metrics.</span></span><br><span class="line"><span class="string">    # Arguments</span></span><br><span class="line"><span class="string">        tp:    True positives (list).</span></span><br><span class="line"><span class="string">        conf:  Objectness value from 0-1 (list).</span></span><br><span class="line"><span class="string">        pred_cls: Predicted object classes (list).</span></span><br><span class="line"><span class="string">        target_cls: True object classes (list).</span></span><br><span class="line"><span class="string">    # Returns</span></span><br><span class="line"><span class="string">        The average precision as computed in py-faster-rcnn.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Sort by objectness</span></span><br><span class="line">    i = np.argsort(-conf)</span><br><span class="line">    tp, conf, pred_cls = tp[i], conf[i], pred_cls[i]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Find unique classes</span></span><br><span class="line">    unique_classes = np.unique(target_cls)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Create Precision-Recall curve and compute AP for each class</span></span><br><span class="line">    ap, p, r = [], [], []</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> unique_classes:</span><br><span class="line">        i = pred_cls == c</span><br><span class="line">        n_gt = (target_cls == c).<span class="built_in">sum</span>()  <span class="comment"># Number of ground truth objects</span></span><br><span class="line">        n_p = i.<span class="built_in">sum</span>()  <span class="comment"># Number of predicted objects</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> n_p == <span class="number">0</span> <span class="keyword">and</span> n_gt == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">elif</span> n_p == <span class="number">0</span> <span class="keyword">or</span> n_gt == <span class="number">0</span>:</span><br><span class="line">            ap.append(<span class="number">0</span>)</span><br><span class="line">            r.append(<span class="number">0</span>)</span><br><span class="line">            p.append(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># Accumulate FPs and TPs</span></span><br><span class="line">            fpc = (<span class="number">1</span> - tp[i]).cumsum()</span><br><span class="line">            tpc = (tp[i]).cumsum()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Recall</span></span><br><span class="line">            recall_curve = tpc / (n_gt + <span class="number">1e-16</span>)</span><br><span class="line">            r.append(recall_curve[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Precision</span></span><br><span class="line">            precision_curve = tpc / (tpc + fpc)</span><br><span class="line">            p.append(precision_curve[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">            <span class="comment"># AP from recall-precision curve</span></span><br><span class="line">            ap.append(compute_ap(recall_curve, precision_curve))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Plot</span></span><br><span class="line">            <span class="comment"># plt.plot(recall_curve, precision_curve)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Compute F1 score (harmonic mean of precision and recall)</span></span><br><span class="line">    p, r, ap = np.array(p), np.array(r), np.array(ap)</span><br><span class="line">    f1 = <span class="number">2</span> * p * r / (p + r + <span class="number">1e-16</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> p, r, ap, f1, unique_classes.astype(<span class="string">&#x27;int32&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compute_ap</span>(<span class="params">recall, precision</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; Compute the average precision, given the recall and precision curves.</span></span><br><span class="line"><span class="string">    Source: https://github.com/rbgirshick/py-faster-rcnn.</span></span><br><span class="line"><span class="string">    # Arguments</span></span><br><span class="line"><span class="string">        recall:    The recall curve (list).</span></span><br><span class="line"><span class="string">        precision: The precision curve (list).</span></span><br><span class="line"><span class="string">    # Returns</span></span><br><span class="line"><span class="string">        The average precision as computed in py-faster-rcnn.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># correct AP calculation</span></span><br><span class="line">    <span class="comment"># first append sentinel values at the end</span></span><br><span class="line"></span><br><span class="line">    mrec = np.concatenate(([<span class="number">0.</span>], recall, [<span class="number">1.</span>]))</span><br><span class="line">    mpre = np.concatenate(([<span class="number">0.</span>], precision, [<span class="number">0.</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># compute the precision envelope</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(mpre.size - <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>):</span><br><span class="line">        mpre[i - <span class="number">1</span>] = np.maximum(mpre[i - <span class="number">1</span>], mpre[i])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># to calculate area under PR curve, look for points</span></span><br><span class="line">    <span class="comment"># where X axis (recall) changes value</span></span><br><span class="line">    i = np.where(mrec[<span class="number">1</span>:] != mrec[:-<span class="number">1</span>])[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># and sum (\Delta recall) * prec</span></span><br><span class="line">    ap = np.<span class="built_in">sum</span>((mrec[i + <span class="number">1</span>] - mrec[i]) * mpre[i + <span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> ap</span><br></pre></td></tr></table></figure>

<p>&nbsp;<br>iou的计算方法（包括GIoU的计算）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bbox_iou</span>(<span class="params">box1, box2, x1y1x2y2=<span class="literal">True</span>, GIoU=<span class="literal">False</span></span>):</span></span><br><span class="line">    <span class="comment"># 这边注意一下，作者的注释已经说了, box1维度(4,), box2可以是多个框的信息(n, 4)</span></span><br><span class="line">    <span class="comment"># Returns the IoU of box1 to box2. box1 is 4, box2 is nx4</span></span><br><span class="line">    box2 = box2.t()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Get the coordinates of bounding boxes</span></span><br><span class="line">    <span class="keyword">if</span> x1y1x2y2:</span><br><span class="line">        <span class="comment"># x1, y1, x2, y2 = box1</span></span><br><span class="line">        b1_x1, b1_y1, b1_x2, b1_y2 = box1[<span class="number">0</span>], box1[<span class="number">1</span>], box1[<span class="number">2</span>], box1[<span class="number">3</span>]</span><br><span class="line">        b2_x1, b2_y1, b2_x2, b2_y2 = box2[<span class="number">0</span>], box2[<span class="number">1</span>], box2[<span class="number">2</span>], box2[<span class="number">3</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># x, y, w, h = box1</span></span><br><span class="line">        b1_x1, b1_x2 = box1[<span class="number">0</span>] - box1[<span class="number">2</span>] / <span class="number">2</span>, box1[<span class="number">0</span>] + box1[<span class="number">2</span>] / <span class="number">2</span></span><br><span class="line">        b1_y1, b1_y2 = box1[<span class="number">1</span>] - box1[<span class="number">3</span>] / <span class="number">2</span>, box1[<span class="number">1</span>] + box1[<span class="number">3</span>] / <span class="number">2</span></span><br><span class="line">        b2_x1, b2_x2 = box2[<span class="number">0</span>] - box2[<span class="number">2</span>] / <span class="number">2</span>, box2[<span class="number">0</span>] + box2[<span class="number">2</span>] / <span class="number">2</span></span><br><span class="line">        b2_y1, b2_y2 = box2[<span class="number">1</span>] - box2[<span class="number">3</span>] / <span class="number">2</span>, box2[<span class="number">1</span>] + box2[<span class="number">3</span>] / <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Intersection area</span></span><br><span class="line">    inter_area = (torch.<span class="built_in">min</span>(b1_x2, b2_x2) - torch.<span class="built_in">max</span>(b1_x1, b2_x1)).clamp(<span class="number">0</span>) * \</span><br><span class="line">                 (torch.<span class="built_in">min</span>(b1_y2, b2_y2) - torch.<span class="built_in">max</span>(b1_y1, b2_y1)).clamp(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Union Area</span></span><br><span class="line">    union_area = ((b1_x2 - b1_x1) * (b1_y2 - b1_y1) + <span class="number">1e-16</span>) + \</span><br><span class="line">                 (b2_x2 - b2_x1) * (b2_y2 - b2_y1) - inter_area</span><br><span class="line"></span><br><span class="line">    iou = inter_area / union_area  <span class="comment"># iou</span></span><br><span class="line">    <span class="keyword">if</span> GIoU:  <span class="comment"># Generalized IoU https://arxiv.org/pdf/1902.09630.pdf</span></span><br><span class="line">        c_x1, c_x2 = torch.<span class="built_in">min</span>(b1_x1, b2_x1), torch.<span class="built_in">max</span>(b1_x2, b2_x2)</span><br><span class="line">        c_y1, c_y2 = torch.<span class="built_in">min</span>(b1_y1, b2_y1), torch.<span class="built_in">max</span>(b1_y2, b2_y2)</span><br><span class="line">        c_area = (c_x2 - c_x1) * (c_y2 - c_y1)  <span class="comment"># convex area</span></span><br><span class="line">        <span class="keyword">return</span> iou - (c_area - union_area) / c_area  <span class="comment"># GIoU</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> iou</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wh_iou</span>(<span class="params">box1, box2</span>):</span></span><br><span class="line">    <span class="comment"># 这边注意一下，作者的注释已经说了, box1维度(2,), box2可以是多个框的信息(n, 2)</span></span><br><span class="line">    <span class="comment"># Returns the IoU of wh1 to wh2. wh1 is 2, wh2 is nx2</span></span><br><span class="line">    box2 = box2.t()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># w, h = box1</span></span><br><span class="line">    w1, h1 = box1[<span class="number">0</span>], box1[<span class="number">1</span>]</span><br><span class="line">    w2, h2 = box2[<span class="number">0</span>], box2[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Intersection area</span></span><br><span class="line">    inter_area = torch.<span class="built_in">min</span>(w1, w2) * torch.<span class="built_in">min</span>(h1, h2)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Union Area</span></span><br><span class="line">    union_area = (w1 * h1 + <span class="number">1e-16</span>) + w2 * h2 - inter_area</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> inter_area / union_area  <span class="comment"># iou</span></span><br></pre></td></tr></table></figure>

<p>&nbsp;<br>重中之中，计算loss的代码<br>yolov3论文中的loss计算方法如下图所示。</p>
<p>![](yolov3代码探究-5 utils.py.assets/8f46b2f9.png)</p>
<p>说明一下p， 在模型的输出中</p>
<ol>
<li>if self.training<br>output.append(YOLOLayer层的输出), yolo层的输出在训练时为(bs, 3, ng, ng, 85), ng是该层的特征图尺寸<br>return output, output维度(3, pi), 其中pi(bs, 3, ng, ng, 85)</li>
<li>else<br>output.append(YOLOLayer层的输出), yolo层的输出包括：<code>io(bs, ng*ng*3, 85)</code>, p(bs, 3, ng, ng, 85)<br>io, p = list(zip(<code>*output</code>)), 做变形<br>io = torch.cat(io, 1) # 从左往右拼接, 拼接以后的维度应该是(bs, 3549, 85)<br>return io, p, p维度(3, pi), 其中pi(bs, 3, ng, ng, 85)<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compute_loss</span>(<span class="params">p, targets, model, giou_loss=<span class="literal">True</span></span>):</span>  <span class="comment"># predictions, targets, model</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    train时直接传p, 测试时时model的输出是io和p，这边传的是第二个输出。维度都是p(3, pi), 其中pi(bs, 3, ng, ng, 85)</span></span><br><span class="line"><span class="string">    targets来源于真实标注，维度(num_of_labels(a batch), 6)，第二个维度的六个值包括(image_id, class, x, y, w, h)</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># ft相当于是定义了一种格式</span></span><br><span class="line">    ft = torch.cuda.FloatTensor <span class="keyword">if</span> p[<span class="number">0</span>].is_cuda <span class="keyword">else</span> torch.Tensor</span><br><span class="line">    lxy, lwh, lcls, lobj = ft([<span class="number">0</span>]), ft([<span class="number">0</span>]), ft([<span class="number">0</span>]), ft([<span class="number">0</span>])</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    txy: (3, num_of_usedAnchors,2)</span></span><br><span class="line"><span class="string">    twh: (3, num_of_usedAnchors, 2)</span></span><br><span class="line"><span class="string">    tcls: (for循环三轮下来之后)(3, num_of_usedAnchors)</span></span><br><span class="line"><span class="string">    tbox: (3, num_of_usedAnchors, 4)</span></span><br><span class="line"><span class="string">    indices: (3, (b,a,gj,gi)); b:(num_of_usedAnchors, ), a:(num_of_usedAnchors, ), gj:(num_of_usedAnchors, ), gi:(num_of_usedAnchors, )</span></span><br><span class="line"><span class="string">    anchor_vec: (3, num_of_usedAnchors, 2)</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    txy, twh, tcls, tbox, indices, anchor_vec = build_targets(model, targets)</span><br><span class="line">    <span class="comment"># 获取模型的参数</span></span><br><span class="line">    h = model.hyp  <span class="comment"># hyperparameters</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Define criteria</span></span><br><span class="line">    <span class="comment"># MSELoss指均方损失函数, MSELoss(x,y) = (x-y)^2</span></span><br><span class="line">    MSE = nn.MSELoss()</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    h[&#x27;cls_pw&#x27;]: 1.957,  # cls BCELoss positive_weight，权重值</span></span><br><span class="line"><span class="string">    h[&#x27;obj_pw&#x27;]: 2.894,  # obj BCELoss positive_weight，权重值</span></span><br><span class="line"><span class="string">     &#x27;&#x27;&#x27;</span></span><br><span class="line">    BCEcls = nn.BCEWithLogitsLoss(pos_weight=ft([h[<span class="string">&#x27;cls_pw&#x27;</span>]])) <span class="comment"># class类别的损失函数</span></span><br><span class="line">    BCEobj = nn.BCEWithLogitsLoss(pos_weight=ft([h[<span class="string">&#x27;obj_pw&#x27;</span>]])) <span class="comment"># object置信度的损失函数</span></span><br><span class="line">    <span class="comment"># CE = nn.CrossEntropyLoss()  # (weight=model.class_weights)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Compute losses</span></span><br><span class="line">    bs = p[<span class="number">0</span>].shape[<span class="number">0</span>]  <span class="comment"># batch size</span></span><br><span class="line">    k = bs / <span class="number">64</span>  <span class="comment"># loss gain</span></span><br><span class="line">    <span class="keyword">for</span> i, pi0 <span class="keyword">in</span> <span class="built_in">enumerate</span>(p):  <span class="comment"># layer i predictions, i</span></span><br><span class="line">        <span class="comment"># p(3, pi0), 其中pi0(bs, 3, ng, ng, 85)</span></span><br><span class="line">        <span class="comment"># b:(num_of_usedAnchors, ), a:(num_of_usedAnchors, ), gj:(num_of_usedAnchors, ), gi:(num_of_usedAnchors, )</span></span><br><span class="line">        b, a, gj, gi = indices[i]  <span class="comment"># image_id, anchor, gridy, gridx</span></span><br><span class="line">        <span class="comment"># tobj: (bs, 3, ng, ng)</span></span><br><span class="line">        tobj = torch.zeros_like(pi0[..., <span class="number">0</span>])  <span class="comment"># target obj</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Compute losses</span></span><br><span class="line">        <span class="comment"># 在这一层中能检测出的labels数量</span></span><br><span class="line">        nb = <span class="built_in">len</span>(b)</span><br><span class="line">        <span class="keyword">if</span> nb:  <span class="comment"># number of targets</span></span><br><span class="line">            <span class="comment"># 如果这一层能检测出真实label, 即有正样本，那就需要算一下lxy + lwh + lcls, 负样本的lxy + lwh + lcls则不需要算</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># pi0是第i个yolo层的输出，pi指在第b张图，第a个anchor,第gj,gi个网格处的检测结果，维度:(num_of_usedAnchors, 85)</span></span><br><span class="line">            pi = pi0[b, a, gj, gi]  <span class="comment"># predictions closest to anchors</span></span><br><span class="line">            <span class="comment"># tobj: 在第b张图，第a个anchor，第gj,gi个网格处检测结果的置信度</span></span><br><span class="line">            tobj[b, a, gj, gi] = <span class="number">1.0</span>  <span class="comment"># obj</span></span><br><span class="line">            <span class="comment"># pi[..., 2:4] = torch.sigmoid(pi[..., 2:4])  # wh power loss (uncomment)</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> giou_loss:</span><br><span class="line">                pbox = torch.cat((torch.sigmoid(pi[..., <span class="number">0</span>:<span class="number">2</span>]), torch.exp(pi[..., <span class="number">2</span>:<span class="number">4</span>]) * anchor_vec[i]), <span class="number">1</span>)  <span class="comment"># predicted</span></span><br><span class="line">                <span class="comment"># 算giou的值</span></span><br><span class="line">                giou = bbox_iou(pbox.t(), tbox[i], x1y1x2y2=<span class="literal">False</span>, GIoU=<span class="literal">True</span>)  <span class="comment"># giou computation</span></span><br><span class="line">                <span class="comment"># lxy += k * 权重 * mean(1-giou)</span></span><br><span class="line">                lxy += (k * h[<span class="string">&#x27;giou&#x27;</span>]) * (<span class="number">1.0</span> - giou).mean()  <span class="comment"># giou loss</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 不使用giou_loss的正常yolo_loss计算， 公式为lxy + lwh + lobj + lcls</span></span><br><span class="line">                <span class="comment"># lxy += k * 权重 * xy的均方误差</span></span><br><span class="line">                lxy += (k * h[<span class="string">&#x27;xy&#x27;</span>]) * MSE(torch.sigmoid(pi[..., <span class="number">0</span>:<span class="number">2</span>]), txy[i])  <span class="comment"># xy loss</span></span><br><span class="line">                <span class="comment"># lwh += k * 权重 * wh的均方误差</span></span><br><span class="line">                lwh += (k * h[<span class="string">&#x27;wh&#x27;</span>]) * MSE(pi[..., <span class="number">2</span>:<span class="number">4</span>], twh[i])  <span class="comment"># wh yolo loss</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># tclsm用来存储真实类别: (num_of_usedAnchors, 80)</span></span><br><span class="line">            tclsm = torch.zeros_like(pi[..., <span class="number">5</span>:])</span><br><span class="line">            <span class="comment"># tcls[i]: (num_of_usedAnchors), 表示的是类别数</span></span><br><span class="line">            tclsm[<span class="built_in">range</span>(nb), tcls[i]] = <span class="number">1.0</span></span><br><span class="line">            <span class="comment"># 算类别loss, lcls += k * 权重 * BCEcls(80种类别)</span></span><br><span class="line">            lcls += (k * h[<span class="string">&#x27;cls&#x27;</span>]) * BCEcls(pi[..., <span class="number">5</span>:], tclsm)  <span class="comment"># cls loss (BCE)</span></span><br><span class="line">            <span class="comment"># lcls += (k * h[&#x27;cls&#x27;]) * CE(pi[..., 5:], tcls[i])  # cls loss (CE)</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Append targets to text file</span></span><br><span class="line">            <span class="comment"># with open(&#x27;targets.txt&#x27;, &#x27;a&#x27;) as file:</span></span><br><span class="line">            <span class="comment">#     [file.write(&#x27;%11.5g &#x27; * 4 % tuple(x) + &#x27;\n&#x27;) for x in torch.cat((txy[i], twh[i]), 1)]</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># object置信度的loss, lobj += k * 权重 * BCEobj(obj置信度)</span></span><br><span class="line">        lobj += (k * h[<span class="string">&#x27;obj&#x27;</span>]) * BCEobj(pi0[..., <span class="number">4</span>], tobj)  <span class="comment"># obj loss</span></span><br><span class="line">        </span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        这边做个解释，如果这个位置是负样本，那就只算lobj</span></span><br><span class="line"><span class="string">        如果是正样本，还要算lxy + lwh + lcls</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">    loss = lxy + lwh + lobj + lcls</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> loss, torch.cat((lxy, lwh, lobj, lcls, loss)).detach()</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>&nbsp;<br>下面的代码是计算loss前的准备工作。它把图像的真实标注和anchor进行比对, 和网络的输出同步（一致），从而用来计算</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_targets</span>(<span class="params">model, targets</span>):</span></span><br><span class="line">    <span class="comment"># targets来源于真实标注，维度(num_of_labels(a batch), 6)，第二个维度的六个值包括(image_id, class, x, y, w, h)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#得到iou的阈值，低于这个阈值的将被舍弃。下面关于iou阈值有个更详细的解释</span></span><br><span class="line">    iou_thres = model.hyp[<span class="string">&#x27;iou_t&#x27;</span>]  <span class="comment"># hyperparameter</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(model) <span class="keyword">in</span> (nn.parallel.DataParallel, nn.parallel.DistributedDataParallel):</span><br><span class="line">        model = model.module</span><br><span class="line"></span><br><span class="line">    nt = <span class="built_in">len</span>(targets) <span class="comment"># nums_of_labels(a batch)</span></span><br><span class="line">    <span class="comment"># 这个是我想要的东西，先初始化</span></span><br><span class="line">    txy, twh, tcls, tbox, indices, anchor_vec = [], [], [], [], [], []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> model.yolo_layers:</span><br><span class="line">        <span class="comment"># 找到所有的yolo层, 一共有三个yolo层，要循环三次</span></span><br><span class="line">        layer = model.module_list[i][<span class="number">0</span>] </span><br><span class="line"></span><br><span class="line">        <span class="comment"># iou of targets-anchors</span></span><br><span class="line">        t, a = targets, [] <span class="comment"># t来自targets, 用于处理变形， a用来存储我需要的anchors</span></span><br><span class="line">        gwh = t[:, <span class="number">4</span>:<span class="number">6</span>] * layer.ng <span class="comment"># # groundTruth wh 从[0,1]区间根据特征图尺寸放大, (num_of_labels(a batch), 2)</span></span><br><span class="line">        <span class="comment"># 作者写的代码，实际上不应该出现nt==0的情况</span></span><br><span class="line">        <span class="keyword">if</span> nt: </span><br><span class="line">            <span class="comment"># layer.anchor_vec(3, 2)</span></span><br><span class="line">            <span class="comment"># wh_iou(box1, box2)计算两个box的iou, 其实box2可为多个框的信息，利用了python的广播机制，维度是(num_of_labels(a batch), 2), torch.stack以后维度是(num_of_labels(a batch) * num_of_anchors, 1)</span></span><br><span class="line">            iou = torch.stack([wh_iou(x, gwh) <span class="keyword">for</span> x <span class="keyword">in</span> layer.anchor_vec], <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">            use_best_anchor = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">if</span> use_best_anchor:</span><br><span class="line">                iou, a = iou.<span class="built_in">max</span>(<span class="number">0</span>)  <span class="comment"># best iou and anchor</span></span><br><span class="line">            <span class="keyword">else</span>:  <span class="comment"># use all anchors</span></span><br><span class="line">                <span class="comment"># number of anchors anchors的数量，应该是3</span></span><br><span class="line">                na = <span class="built_in">len</span>(layer.anchor_vec)  </span><br><span class="line">                <span class="comment"># a: (3, )-&gt;(3,1)-&gt;(3, num_of_labels(a batch))-&gt;(3*num_of_labels(a batch), ), 即(num_of_labels(a batch)*num_of_anchors, )</span></span><br><span class="line">                a = torch.arange(na).view((-<span class="number">1</span>, <span class="number">1</span>)).repeat([<span class="number">1</span>, nt]).view(-<span class="number">1</span>)</span><br><span class="line">                <span class="comment"># t: (num_of_labels(a batch), 6)-&gt;(num_of_labels(a batch)*num_of_anchors, 6)</span></span><br><span class="line">                t = targets.repeat([na, <span class="number">1</span>])</span><br><span class="line">                <span class="comment"># gwh: (num_of_labels(a batch), 2)-&gt;(num_of_labels(a batch)*num_of_anchors, 2)</span></span><br><span class="line">                gwh = gwh.repeat([na, <span class="number">1</span>])</span><br><span class="line">                <span class="comment"># iou: (num_of_labels(a batch) * num_of_anchors, 1)-&gt;(num_of_labels(a batch) * num_of_anchors, )</span></span><br><span class="line">                iou = iou.view(-<span class="number">1</span>)  <span class="comment"># use all ious</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># reject anchors below iou_thres (OPTIONAL, increases P, lowers R)</span></span><br><span class="line">            reject = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">if</span> reject:</span><br><span class="line">                <span class="comment"># j: (num_of_labels(a batch) * num_of_anchors, ), 全由0/1构成</span></span><br><span class="line">                j = iou &gt; iou_thres</span><br><span class="line">                <span class="comment"># 这里很细节！！tensor1[tensor2]见简书, 得到的是t中满足iou&gt;iou_thres的信息，将满足的数量记为 (num_of_usedAnchors, _)</span></span><br><span class="line">                <span class="comment"># t: (num_of_usedAnchors, 6), a: (num_of_usedAnchors, ), gwh: (num_of_usedAnchors, 2)</span></span><br><span class="line">                t, a, gwh = t[j], a[j], gwh[j]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Indices</span></span><br><span class="line">        <span class="comment"># tensor.long()将tensor转为Long类型的张量, long即长整形</span></span><br><span class="line">        <span class="comment"># b: img_id, (num_of_usedAnchors, ), c: class, (num_of_usedAnchors, )</span></span><br><span class="line">        b, c = t[:, :<span class="number">2</span>].long().t()  <span class="comment"># target image, class</span></span><br><span class="line">        <span class="comment"># gxy: 中心点在该特征图上的坐标 (num_of_usedAnchors, 2)</span></span><br><span class="line">        gxy = t[:, <span class="number">2</span>:<span class="number">4</span>] * layer.ng  <span class="comment"># grid x, y</span></span><br><span class="line">        <span class="comment"># gi, gj: (num_of_trueAnchors, 2)-&gt;2个(num_of_usedAnchors, ), 表示网格的坐标</span></span><br><span class="line">        gi, gj = gxy.long().t()  <span class="comment"># grid x, y indices</span></span><br><span class="line">        <span class="comment"># indices: (for循环三轮下来之后)(3, (b,a,gj,gi))</span></span><br><span class="line">        <span class="comment"># b:(num_of_usedAnchors, ), a:(num_of_usedAnchors, ), gj:(num_of_usedAnchors, ), gi:(num_of_usedAnchors, )</span></span><br><span class="line">        indices.append((b, a, gj, gi))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># XY coordinates</span></span><br><span class="line">        <span class="comment"># gxy: 得到中心点在某个网格上的坐标 (num_of_usedAnchors,2)</span></span><br><span class="line">        gxy -= gxy.floor()</span><br><span class="line">        <span class="comment"># txy: (for循环三轮下来之后)(3, num_of_usedAnchors,2)</span></span><br><span class="line">        txy.append(gxy)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># GIoU, CVPR2019中新的衡量标准</span></span><br><span class="line">        <span class="comment"># xywh (grids) 基于某个网格的信息存到tbox中，也是网络希望得到的结果</span></span><br><span class="line">        <span class="comment"># tbox: (for循环三轮下来之后)(3, num_of_usedAnchors, 4)</span></span><br><span class="line">        tbox.append(torch.cat((gxy, gwh), <span class="number">1</span>))  <span class="comment"># xywh (grids)</span></span><br><span class="line">        <span class="comment"># a是满足iou&gt;iou_thres的anchor信息（存的是编号）, (num_of_usedAnchors, )。layer.anchor_vec:(3,2)。</span></span><br><span class="line">        <span class="comment"># layer.anchor_vec[a]: (num_of_usedAnchors, 2)</span></span><br><span class="line">        <span class="comment"># anchor_vec: 满足iou&gt;iou_thres的anchor信息（存的是值）(for循环三轮下来之后)(3, num_of_usedAnchors, 2)</span></span><br><span class="line">        anchor_vec.append(layer.anchor_vec[a])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Width and height</span></span><br><span class="line">        <span class="comment"># twh: (for循环三轮下来之后)(3, num_of_usedAnchors, 2)</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;         </span></span><br><span class="line"><span class="string">        下面一行代码解释一下。</span></span><br><span class="line"><span class="string">        让我们回想一下网络得到的xywh是怎么变成我们真正想要的值的呢？没错！         </span></span><br><span class="line"><span class="string">        xy = sigmoid(xy) +　offset         </span></span><br><span class="line"><span class="string">        wh = exp(wh) * anchor_wh         </span></span><br><span class="line"><span class="string">        所以这边我们希望得到的twh应该逆处理一下        </span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        twh.append(torch.log(gwh / layer.anchor_vec[a]))  <span class="comment"># wh yolo method</span></span><br><span class="line">        <span class="comment"># twh.append((gwh / layer.anchor_vec[a]) ** (1 / 3) / 2)  # wh power method</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Class</span></span><br><span class="line">        <span class="comment"># tcls: (for循环三轮下来之后)(3, num_of_usedAnchors)</span></span><br><span class="line">        tcls.append(c)</span><br><span class="line">        <span class="keyword">if</span> c.shape[<span class="number">0</span>]:</span><br><span class="line">            <span class="keyword">assert</span> c.<span class="built_in">max</span>() &lt;= layer.nc, <span class="string">&#x27;Target classes exceed model classes&#x27;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment"># txy: (3, num_of_usedAnchors,2)</span></span><br><span class="line">    <span class="comment"># twh: (3, num_of_usedAnchors, 2)</span></span><br><span class="line">    <span class="comment"># tcls: (for循环三轮下来之后)(3, num_of_usedAnchors)</span></span><br><span class="line">    <span class="comment"># tbox: (3, num_of_usedAnchors, 4)</span></span><br><span class="line">    <span class="comment"># indices: (3, (b,a,gj,gi)); b:(num_of_usedAnchors, ), a:(num_of_usedAnchors, ), gj:(num_of_usedAnchors, ), gi:(num_of_usedAnchors, )</span></span><br><span class="line">    <span class="comment"># anchor_vec: (3, num_of_usedAnchors, 2)</span></span><br><span class="line">    <span class="keyword">return</span> txy, twh, tcls, tbox, indices, anchor_vec</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">non_max_suppression</span>(<span class="params">prediction, conf_thres=<span class="number">0.5</span>, nms_thres=<span class="number">0.5</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Removes detections with lower object confidence score than &#x27;conf_thres&#x27;</span></span><br><span class="line"><span class="string">    Non-Maximum Suppression to further filter detections.</span></span><br><span class="line"><span class="string">    Returns detections with shape:</span></span><br><span class="line"><span class="string">        (x1, y1, x2, y2, object_conf, class_conf, class)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    min_wh = <span class="number">2</span>  <span class="comment"># (pixels) minimum box width and height</span></span><br><span class="line"></span><br><span class="line">    output = [<span class="literal">None</span>] * <span class="built_in">len</span>(prediction)</span><br><span class="line">    <span class="keyword">for</span> image_i, pred <span class="keyword">in</span> <span class="built_in">enumerate</span>(prediction):</span><br><span class="line">        <span class="comment"># Experiment: Prior class size rejection</span></span><br><span class="line">        <span class="comment"># x, y, w, h = pred[:, 0], pred[:, 1], pred[:, 2], pred[:, 3]</span></span><br><span class="line">        <span class="comment"># a = w * h  # area</span></span><br><span class="line">        <span class="comment"># ar = w / (h + 1e-16)  # aspect ratio</span></span><br><span class="line">        <span class="comment"># n = len(w)</span></span><br><span class="line">        <span class="comment"># log_w, log_h, log_a, log_ar = torch.log(w), torch.log(h), torch.log(a), torch.log(ar)</span></span><br><span class="line">        <span class="comment"># shape_likelihood = np.zeros((n, 60), dtype=np.float32)</span></span><br><span class="line">        <span class="comment"># x = np.concatenate((log_w.reshape(-1, 1), log_h.reshape(-1, 1)), 1)</span></span><br><span class="line">        <span class="comment"># from scipy.stats import multivariate_normal</span></span><br><span class="line">        <span class="comment"># for c in range(60):</span></span><br><span class="line">        <span class="comment"># shape_likelihood[:, c] =</span></span><br><span class="line">        <span class="comment">#   multivariate_normal.pdf(x, mean=mat[&#x27;class_mu&#x27;][c, :2], cov=mat[&#x27;class_cov&#x27;][c, :2, :2])</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Multiply conf by class conf to get combined confidence</span></span><br><span class="line">        class_conf, class_pred = pred[:, <span class="number">5</span>:].<span class="built_in">max</span>(<span class="number">1</span>)</span><br><span class="line">        pred[:, <span class="number">4</span>] *= class_conf</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Select only suitable predictions</span></span><br><span class="line">        i = (pred[:, <span class="number">4</span>] &gt; conf_thres) &amp; (pred[:, <span class="number">2</span>:<span class="number">4</span>] &gt; min_wh).<span class="built_in">all</span>(<span class="number">1</span>) &amp; torch.isfinite(pred).<span class="built_in">all</span>(<span class="number">1</span>)</span><br><span class="line">        pred = pred[i]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># If none are remaining =&gt; process next image</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(pred) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Select predicted classes</span></span><br><span class="line">        class_conf = class_conf[i]</span><br><span class="line">        class_pred = class_pred[i].unsqueeze(<span class="number">1</span>).<span class="built_in">float</span>()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Box (center x, center y, width, height) to (x1, y1, x2, y2)</span></span><br><span class="line">        pred[:, :<span class="number">4</span>] = xywh2xyxy(pred[:, :<span class="number">4</span>])</span><br><span class="line">        <span class="comment"># pred[:, 4] *= class_conf  # improves mAP from 0.549 to 0.551</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Detections ordered as (x1y1x2y2, obj_conf, class_conf, class_pred)</span></span><br><span class="line">        pred = torch.cat((pred[:, :<span class="number">5</span>], class_conf.unsqueeze(<span class="number">1</span>), class_pred), <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Get detections sorted by decreasing confidence scores</span></span><br><span class="line">        pred = pred[(-pred[:, <span class="number">4</span>]).argsort()]</span><br><span class="line"></span><br><span class="line">        det_max = []</span><br><span class="line">        nms_style = <span class="string">&#x27;MERGE&#x27;</span>  <span class="comment"># &#x27;OR&#x27; (default), &#x27;AND&#x27;, &#x27;MERGE&#x27; (experimental)</span></span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> pred[:, -<span class="number">1</span>].unique():</span><br><span class="line">            dc = pred[pred[:, -<span class="number">1</span>] == c]  <span class="comment"># select class c</span></span><br><span class="line">            n = <span class="built_in">len</span>(dc)</span><br><span class="line">            <span class="keyword">if</span> n == <span class="number">1</span>:</span><br><span class="line">                det_max.append(dc)  <span class="comment"># No NMS required if only 1 prediction</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">elif</span> n &gt; <span class="number">100</span>:</span><br><span class="line">                dc = dc[:<span class="number">100</span>]  <span class="comment"># limit to first 100 boxes: https://github.com/ultralytics/yolov3/issues/117</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Non-maximum suppression</span></span><br><span class="line">            <span class="keyword">if</span> nms_style == <span class="string">&#x27;OR&#x27;</span>:  <span class="comment"># default</span></span><br><span class="line">                <span class="comment"># METHOD1</span></span><br><span class="line">                <span class="comment"># ind = list(range(len(dc)))</span></span><br><span class="line">                <span class="comment"># while len(ind):</span></span><br><span class="line">                <span class="comment"># j = ind[0]</span></span><br><span class="line">                <span class="comment"># det_max.append(dc[j:j + 1])  # save highest conf detection</span></span><br><span class="line">                <span class="comment"># reject = (bbox_iou(dc[j], dc[ind]) &gt; nms_thres).nonzero()</span></span><br><span class="line">                <span class="comment"># [ind.pop(i) for i in reversed(reject)]</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># METHOD2</span></span><br><span class="line">                <span class="keyword">while</span> dc.shape[<span class="number">0</span>]:</span><br><span class="line">                    det_max.append(dc[:<span class="number">1</span>])  <span class="comment"># save highest conf detection</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">len</span>(dc) == <span class="number">1</span>:  <span class="comment"># Stop if we&#x27;re at the last detection</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    iou = bbox_iou(dc[<span class="number">0</span>], dc[<span class="number">1</span>:])  <span class="comment"># iou with other boxes</span></span><br><span class="line">                    dc = dc[<span class="number">1</span>:][iou &lt; nms_thres]  <span class="comment"># remove ious &gt; threshold</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> nms_style == <span class="string">&#x27;AND&#x27;</span>:  <span class="comment"># requires overlap, single boxes erased</span></span><br><span class="line">                <span class="keyword">while</span> <span class="built_in">len</span>(dc) &gt; <span class="number">1</span>:</span><br><span class="line">                    iou = bbox_iou(dc[<span class="number">0</span>], dc[<span class="number">1</span>:])  <span class="comment"># iou with other boxes</span></span><br><span class="line">                    <span class="keyword">if</span> iou.<span class="built_in">max</span>() &gt; <span class="number">0.5</span>:</span><br><span class="line">                        det_max.append(dc[:<span class="number">1</span>])</span><br><span class="line">                    dc = dc[<span class="number">1</span>:][iou &lt; nms_thres]  <span class="comment"># remove ious &gt; threshold</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> nms_style == <span class="string">&#x27;MERGE&#x27;</span>:  <span class="comment"># weighted mixture box</span></span><br><span class="line">                <span class="keyword">while</span> <span class="built_in">len</span>(dc):</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">len</span>(dc) == <span class="number">1</span>:</span><br><span class="line">                        det_max.append(dc)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    i = bbox_iou(dc[<span class="number">0</span>], dc) &gt; nms_thres  <span class="comment"># iou with other boxes</span></span><br><span class="line">                    weights = dc[i, <span class="number">4</span>:<span class="number">5</span>]</span><br><span class="line">                    dc[<span class="number">0</span>, :<span class="number">4</span>] = (weights * dc[i, :<span class="number">4</span>]).<span class="built_in">sum</span>(<span class="number">0</span>) / weights.<span class="built_in">sum</span>()</span><br><span class="line">                    det_max.append(dc[:<span class="number">1</span>])</span><br><span class="line">                    dc = dc[i == <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> nms_style == <span class="string">&#x27;SOFT&#x27;</span>:  <span class="comment"># soft-NMS https://arxiv.org/abs/1704.04503</span></span><br><span class="line">                sigma = <span class="number">0.5</span>  <span class="comment"># soft-nms sigma parameter</span></span><br><span class="line">                <span class="keyword">while</span> <span class="built_in">len</span>(dc):</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">len</span>(dc) == <span class="number">1</span>:</span><br><span class="line">                        det_max.append(dc)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    det_max.append(dc[:<span class="number">1</span>])</span><br><span class="line">                    iou = bbox_iou(dc[<span class="number">0</span>], dc[<span class="number">1</span>:])  <span class="comment"># iou with other boxes</span></span><br><span class="line">                    dc = dc[<span class="number">1</span>:]</span><br><span class="line">                    dc[:, <span class="number">4</span>] *= torch.exp(-iou ** <span class="number">2</span> / sigma)  <span class="comment"># decay confidences</span></span><br><span class="line">                    <span class="comment"># dc = dc[dc[:, 4] &gt; nms_thres]  # new line per https://github.com/ultralytics/yolov3/issues/362</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(det_max):</span><br><span class="line">            det_max = torch.cat(det_max)  <span class="comment"># concatenate</span></span><br><span class="line">            output[image_i] = det_max[(-det_max[:, <span class="number">4</span>]).argsort()]  <span class="comment"># sort</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_yolo_layers</span>(<span class="params">model</span>):</span></span><br><span class="line">    bool_vec = [x[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;yolo&#x27;</span> <span class="keyword">for</span> x <span class="keyword">in</span> model.module_defs]</span><br><span class="line">    <span class="keyword">return</span> [i <span class="keyword">for</span> i, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(bool_vec) <span class="keyword">if</span> x]  <span class="comment"># [82, 94, 106] for yolov3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">strip_optimizer_from_checkpoint</span>(<span class="params">filename=<span class="string">&#x27;weights/best.pt&#x27;</span></span>):</span></span><br><span class="line">    <span class="comment"># Strip optimizer from *.pt files for lighter files (reduced by 2/3 size)</span></span><br><span class="line">    a = torch.load(filename, map_location=<span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line">    a[<span class="string">&#x27;optimizer&#x27;</span>] = []</span><br><span class="line">    torch.save(a, filename.replace(<span class="string">&#x27;.pt&#x27;</span>, <span class="string">&#x27;_lite.pt&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">coco_class_count</span>(<span class="params">path=<span class="string">&#x27;../coco/labels/train2014/&#x27;</span></span>):</span></span><br><span class="line">    <span class="comment"># Histogram of occurrences per class</span></span><br><span class="line">    nc = <span class="number">80</span>  <span class="comment"># number classes</span></span><br><span class="line">    x = np.zeros(nc, dtype=<span class="string">&#x27;int32&#x27;</span>)</span><br><span class="line">    files = <span class="built_in">sorted</span>(glob.glob(<span class="string">&#x27;%s/*.*&#x27;</span> % path))</span><br><span class="line">    <span class="keyword">for</span> i, file <span class="keyword">in</span> <span class="built_in">enumerate</span>(files):</span><br><span class="line">        labels = np.loadtxt(file, dtype=np.float32).reshape(-<span class="number">1</span>, <span class="number">5</span>)</span><br><span class="line">        x += np.bincount(labels[:, <span class="number">0</span>].astype(<span class="string">&#x27;int32&#x27;</span>), minlength=nc)</span><br><span class="line">        print(i, <span class="built_in">len</span>(files))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">coco_only_people</span>(<span class="params">path=<span class="string">&#x27;../coco/labels/val2014/&#x27;</span></span>):</span></span><br><span class="line">    <span class="comment"># Find images with only people</span></span><br><span class="line">    files = <span class="built_in">sorted</span>(glob.glob(<span class="string">&#x27;%s/*.*&#x27;</span> % path))</span><br><span class="line">    <span class="keyword">for</span> i, file <span class="keyword">in</span> <span class="built_in">enumerate</span>(files):</span><br><span class="line">        labels = np.loadtxt(file, dtype=np.float32).reshape(-<span class="number">1</span>, <span class="number">5</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">all</span>(labels[:, <span class="number">0</span>] == <span class="number">0</span>):</span><br><span class="line">            print(labels.shape[<span class="number">0</span>], file)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">select_best_evolve</span>(<span class="params">path=<span class="string">&#x27;../../Downloads/evolve*.txt&#x27;</span></span>):</span>  <span class="comment"># from utils.utils import *; select_best_evolve()</span></span><br><span class="line">    <span class="comment"># Find best evolved mutation</span></span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> <span class="built_in">sorted</span>(glob.glob(path)):</span><br><span class="line">        x = np.loadtxt(file, dtype=np.float32)</span><br><span class="line">        print(file, x[x[:, <span class="number">2</span>].argmax()])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">kmeans_targets</span>(<span class="params">path=<span class="string">&#x27;./data/coco_64img.txt&#x27;</span></span>):</span>  <span class="comment"># from utils.utils import *; kmeans_targets()</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        img_files = f.read().splitlines()</span><br><span class="line">        img_files = <span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="keyword">lambda</span> x: <span class="built_in">len</span>(x) &gt; <span class="number">0</span>, img_files))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Read shapes</span></span><br><span class="line">    n = <span class="built_in">len</span>(img_files)</span><br><span class="line">    <span class="keyword">assert</span> n &gt; <span class="number">0</span>, <span class="string">&#x27;No images found in %s&#x27;</span> % path</span><br><span class="line">    label_files = [x.replace(<span class="string">&#x27;images&#x27;</span>, <span class="string">&#x27;labels&#x27;</span>).</span><br><span class="line">                       replace(<span class="string">&#x27;.jpeg&#x27;</span>, <span class="string">&#x27;.txt&#x27;</span>).</span><br><span class="line">                       replace(<span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.txt&#x27;</span>).</span><br><span class="line">                       replace(<span class="string">&#x27;.bmp&#x27;</span>, <span class="string">&#x27;.txt&#x27;</span>).</span><br><span class="line">                       replace(<span class="string">&#x27;.png&#x27;</span>, <span class="string">&#x27;.txt&#x27;</span>) <span class="keyword">for</span> x <span class="keyword">in</span> img_files]</span><br><span class="line">    s = np.array([Image.<span class="built_in">open</span>(f).size <span class="keyword">for</span> f <span class="keyword">in</span> tqdm(img_files, desc=<span class="string">&#x27;Reading image shapes&#x27;</span>)])  <span class="comment"># (width, height)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Read targets</span></span><br><span class="line">    labels = [np.zeros((<span class="number">0</span>, <span class="number">5</span>))] * n</span><br><span class="line">    <span class="built_in">iter</span> = tqdm(label_files, desc=<span class="string">&#x27;Reading labels&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i, file <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="built_in">iter</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(file, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                l = np.array([x.split() <span class="keyword">for</span> x <span class="keyword">in</span> f.read().splitlines()], dtype=np.float32)</span><br><span class="line">                <span class="keyword">if</span> l.shape[<span class="number">0</span>]:</span><br><span class="line">                    <span class="keyword">assert</span> l.shape[<span class="number">1</span>] == <span class="number">5</span>, <span class="string">&#x27;&gt; 5 label columns: %s&#x27;</span> % file</span><br><span class="line">                    <span class="keyword">assert</span> (l &gt;= <span class="number">0</span>).<span class="built_in">all</span>(), <span class="string">&#x27;negative labels: %s&#x27;</span> % file</span><br><span class="line">                    <span class="keyword">assert</span> (l[:, <span class="number">1</span>:] &lt;= <span class="number">1</span>).<span class="built_in">all</span>(), <span class="string">&#x27;non-normalized or out of bounds coordinate labels: %s&#x27;</span> % file</span><br><span class="line">                    l[:, [<span class="number">1</span>, <span class="number">3</span>]] *= s[i][<span class="number">0</span>]</span><br><span class="line">                    l[:, [<span class="number">2</span>, <span class="number">4</span>]] *= s[i][<span class="number">1</span>]</span><br><span class="line">                    l[:, <span class="number">1</span>:] *= <span class="number">320</span> / <span class="built_in">max</span>(s[i])</span><br><span class="line">                    labels[i] = l</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span>  <span class="comment"># print(&#x27;Warning: missing labels for %s&#x27; % self.img_files[i])  # missing label file</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(np.concatenate(labels, <span class="number">0</span>)) &gt; <span class="number">0</span>, <span class="string">&#x27;No labels found. Incorrect label paths provided.&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># kmeans</span></span><br><span class="line">    <span class="keyword">from</span> scipy <span class="keyword">import</span> cluster</span><br><span class="line">    wh = np.concatenate(labels, <span class="number">0</span>)[:, <span class="number">3</span>:<span class="number">5</span>]</span><br><span class="line">    k = cluster.vq.kmeans(wh, <span class="number">9</span>)[<span class="number">0</span>]</span><br><span class="line">    k = k[np.argsort(k.prod(<span class="number">1</span>))]</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> k.ravel():</span><br><span class="line">        print(<span class="string">&#x27;%.1f, &#x27;</span> % x, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Plotting functions ---------------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_one_box</span>(<span class="params">x, img, color=<span class="literal">None</span>, label=<span class="literal">None</span>, line_thickness=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="comment"># Plots one bounding box on image img</span></span><br><span class="line">    tl = line_thickness <span class="keyword">or</span> <span class="built_in">round</span>(<span class="number">0.002</span> * (img.shape[<span class="number">0</span>] + img.shape[<span class="number">1</span>]) / <span class="number">2</span>) + <span class="number">1</span>  <span class="comment"># line thickness</span></span><br><span class="line">    color = color <span class="keyword">or</span> [random.randint(<span class="number">0</span>, <span class="number">255</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)]</span><br><span class="line">    c1, c2 = (<span class="built_in">int</span>(x[<span class="number">0</span>]), <span class="built_in">int</span>(x[<span class="number">1</span>])), (<span class="built_in">int</span>(x[<span class="number">2</span>]), <span class="built_in">int</span>(x[<span class="number">3</span>]))</span><br><span class="line">    cv2.rectangle(img, c1, c2, color, thickness=tl)</span><br><span class="line">    <span class="keyword">if</span> label:</span><br><span class="line">        tf = <span class="built_in">max</span>(tl - <span class="number">1</span>, <span class="number">1</span>)  <span class="comment"># font thickness</span></span><br><span class="line">        t_size = cv2.getTextSize(label, <span class="number">0</span>, fontScale=tl / <span class="number">3</span>, thickness=tf)[<span class="number">0</span>]</span><br><span class="line">        c2 = c1[<span class="number">0</span>] + t_size[<span class="number">0</span>], c1[<span class="number">1</span>] - t_size[<span class="number">1</span>] - <span class="number">3</span></span><br><span class="line">        cv2.rectangle(img, c1, c2, color, -<span class="number">1</span>)  <span class="comment"># filled</span></span><br><span class="line">        cv2.putText(img, label, (c1[<span class="number">0</span>], c1[<span class="number">1</span>] - <span class="number">2</span>), <span class="number">0</span>, tl / <span class="number">3</span>, [<span class="number">225</span>, <span class="number">255</span>, <span class="number">255</span>], thickness=tf, lineType=cv2.LINE_AA)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_wh_methods</span>():</span>  <span class="comment"># from utils.utils import *; plot_wh_methods()</span></span><br><span class="line">    <span class="comment"># Compares the two methods for width-height anchor multiplication</span></span><br><span class="line">    <span class="comment"># https://github.com/ultralytics/yolov3/issues/168</span></span><br><span class="line">    x = np.arange(-<span class="number">4.0</span>, <span class="number">4.0</span>, <span class="number">.1</span>)</span><br><span class="line">    ya = np.exp(x)</span><br><span class="line">    yb = torch.sigmoid(torch.from_numpy(x)).numpy() * <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    fig = plt.figure(figsize=(<span class="number">6</span>, <span class="number">3</span>), dpi=<span class="number">150</span>)</span><br><span class="line">    plt.plot(x, ya, <span class="string">&#x27;.-&#x27;</span>, label=<span class="string">&#x27;yolo method&#x27;</span>)</span><br><span class="line">    plt.plot(x, yb ** <span class="number">2</span>, <span class="string">&#x27;.-&#x27;</span>, label=<span class="string">&#x27;^2 power method&#x27;</span>)</span><br><span class="line">    plt.plot(x, yb ** <span class="number">2.5</span>, <span class="string">&#x27;.-&#x27;</span>, label=<span class="string">&#x27;^2.5 power method&#x27;</span>)</span><br><span class="line">    plt.xlim(left=-<span class="number">4</span>, right=<span class="number">4</span>)</span><br><span class="line">    plt.ylim(bottom=<span class="number">0</span>, top=<span class="number">6</span>)</span><br><span class="line">    plt.xlabel(<span class="string">&#x27;input&#x27;</span>)</span><br><span class="line">    plt.ylabel(<span class="string">&#x27;output&#x27;</span>)</span><br><span class="line">    plt.legend()</span><br><span class="line">    fig.tight_layout()</span><br><span class="line">    fig.savefig(<span class="string">&#x27;comparison.png&#x27;</span>, dpi=<span class="number">300</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_images</span>(<span class="params">imgs, targets, paths=<span class="literal">None</span>, fname=<span class="string">&#x27;images.jpg&#x27;</span></span>):</span></span><br><span class="line">    <span class="comment"># Plots training images overlaid with targets</span></span><br><span class="line">    imgs = imgs.cpu().numpy()</span><br><span class="line">    targets = targets.cpu().numpy()</span><br><span class="line">    <span class="comment"># targets = targets[targets[:, 1] == 21]  # plot only one class</span></span><br><span class="line"></span><br><span class="line">    fig = plt.figure(figsize=(<span class="number">10</span>, <span class="number">10</span>))</span><br><span class="line">    bs, _, h, w = imgs.shape  <span class="comment"># batch size, _, height, width</span></span><br><span class="line">    ns = np.ceil(bs ** <span class="number">0.5</span>)  <span class="comment"># number of subplots</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(bs):</span><br><span class="line">        boxes = xywh2xyxy(targets[targets[:, <span class="number">0</span>] == i, <span class="number">2</span>:<span class="number">6</span>]).T</span><br><span class="line">        boxes[[<span class="number">0</span>, <span class="number">2</span>]] *= w</span><br><span class="line">        boxes[[<span class="number">1</span>, <span class="number">3</span>]] *= h</span><br><span class="line">        plt.subplot(ns, ns, i + <span class="number">1</span>).imshow(imgs[i].transpose(<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>))</span><br><span class="line">        plt.plot(boxes[[<span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>]], boxes[[<span class="number">1</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">1</span>]], <span class="string">&#x27;.-&#x27;</span>)</span><br><span class="line">        plt.axis(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> paths <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            s = Path(paths[i]).name</span><br><span class="line">            plt.title(s[:<span class="built_in">min</span>(<span class="built_in">len</span>(s), <span class="number">40</span>)], fontdict=&#123;<span class="string">&#x27;size&#x27;</span>: <span class="number">8</span>&#125;)  <span class="comment"># limit to 40 characters</span></span><br><span class="line">    fig.tight_layout()</span><br><span class="line">    fig.savefig(fname, dpi=<span class="number">300</span>)</span><br><span class="line">    plt.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_test_txt</span>():</span>  <span class="comment"># from utils.utils import *; plot_test()</span></span><br><span class="line">    <span class="comment"># Plot test.txt histograms</span></span><br><span class="line">    x = np.loadtxt(<span class="string">&#x27;test.txt&#x27;</span>, dtype=np.float32)</span><br><span class="line">    box = xyxy2xywh(x[:, :<span class="number">4</span>])</span><br><span class="line">    cx, cy = box[:, <span class="number">0</span>], box[:, <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    fig, ax = plt.subplots(<span class="number">1</span>, <span class="number">1</span>, figsize=(<span class="number">6</span>, <span class="number">6</span>))</span><br><span class="line">    ax.hist2d(cx, cy, bins=<span class="number">600</span>, cmax=<span class="number">10</span>, cmin=<span class="number">0</span>)</span><br><span class="line">    ax.set_aspect(<span class="string">&#x27;equal&#x27;</span>)</span><br><span class="line">    fig.tight_layout()</span><br><span class="line">    plt.savefig(<span class="string">&#x27;hist2d.jpg&#x27;</span>, dpi=<span class="number">300</span>)</span><br><span class="line"></span><br><span class="line">    fig, ax = plt.subplots(<span class="number">1</span>, <span class="number">2</span>, figsize=(<span class="number">12</span>, <span class="number">6</span>))</span><br><span class="line">    ax[<span class="number">0</span>].hist(cx, bins=<span class="number">600</span>)</span><br><span class="line">    ax[<span class="number">1</span>].hist(cy, bins=<span class="number">600</span>)</span><br><span class="line">    fig.tight_layout()</span><br><span class="line">    plt.savefig(<span class="string">&#x27;hist1d.jpg&#x27;</span>, dpi=<span class="number">300</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_targets_txt</span>():</span>  <span class="comment"># from utils.utils import *; plot_targets_txt()</span></span><br><span class="line">    <span class="comment"># Plot test.txt histograms</span></span><br><span class="line">    x = np.loadtxt(<span class="string">&#x27;targets.txt&#x27;</span>, dtype=np.float32)</span><br><span class="line">    x = x.T</span><br><span class="line"></span><br><span class="line">    s = [<span class="string">&#x27;x targets&#x27;</span>, <span class="string">&#x27;y targets&#x27;</span>, <span class="string">&#x27;width targets&#x27;</span>, <span class="string">&#x27;height targets&#x27;</span>]</span><br><span class="line">    fig, ax = plt.subplots(<span class="number">2</span>, <span class="number">2</span>, figsize=(<span class="number">8</span>, <span class="number">8</span>))</span><br><span class="line">    ax = ax.ravel()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        ax[i].hist(x[i], bins=<span class="number">100</span>, label=<span class="string">&#x27;%.3g +/- %.3g&#x27;</span> % (x[i].mean(), x[i].std()))</span><br><span class="line">        ax[i].legend()</span><br><span class="line">        ax[i].set_title(s[i])</span><br><span class="line">    fig.tight_layout()</span><br><span class="line">    plt.savefig(<span class="string">&#x27;targets.jpg&#x27;</span>, dpi=<span class="number">300</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_results</span>(<span class="params">start=<span class="number">0</span>, stop=<span class="number">0</span></span>):</span>  <span class="comment"># from utils.utils import *; plot_results()</span></span><br><span class="line">    <span class="comment"># Plot training results files &#x27;results*.txt&#x27;</span></span><br><span class="line">    <span class="comment"># import os; os.system(&#x27;wget https://storage.googleapis.com/ultralytics/yolov3/results_v3.txt&#x27;)</span></span><br><span class="line"></span><br><span class="line">    fig, ax = plt.subplots(<span class="number">2</span>, <span class="number">5</span>, figsize=(<span class="number">14</span>, <span class="number">7</span>))</span><br><span class="line">    ax = ax.ravel()</span><br><span class="line">    s = [<span class="string">&#x27;X + Y&#x27;</span>, <span class="string">&#x27;Width + Height&#x27;</span>, <span class="string">&#x27;Confidence&#x27;</span>, <span class="string">&#x27;Classification&#x27;</span>, <span class="string">&#x27;Train Loss&#x27;</span>, <span class="string">&#x27;Precision&#x27;</span>, <span class="string">&#x27;Recall&#x27;</span>, <span class="string">&#x27;mAP&#x27;</span>, <span class="string">&#x27;F1&#x27;</span>,</span><br><span class="line">         <span class="string">&#x27;Test Loss&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> <span class="built_in">sorted</span>(glob.glob(<span class="string">&#x27;results*.txt&#x27;</span>) + glob.glob(<span class="string">&#x27;../../Downloads/results*.txt&#x27;</span>)):</span><br><span class="line">        results = np.loadtxt(f, usecols=[<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>]).T</span><br><span class="line">        n = results.shape[<span class="number">1</span>]  <span class="comment"># number of rows</span></span><br><span class="line">        x = <span class="built_in">range</span>(start, <span class="built_in">min</span>(stop, n) <span class="keyword">if</span> stop <span class="keyword">else</span> n)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">            ax[i].plot(x, results[i, x], marker=<span class="string">&#x27;.&#x27;</span>, label=f.replace(<span class="string">&#x27;.txt&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">            ax[i].set_title(s[i])</span><br><span class="line">    fig.tight_layout()</span><br><span class="line">    ax[<span class="number">4</span>].legend()</span><br><span class="line">    fig.savefig(<span class="string">&#x27;results.png&#x27;</span>, dpi=<span class="number">300</span>)</span><br></pre></td></tr></table></figure>
        </div>
        
<blockquote class="copyright">
    <p><strong>Link to this article : </strong><a class="permalink" href="http://yoursite.com/2020/02/04/deep_learning/yolo/yolov3%E4%BB%A3%E7%A0%81%E6%8E%A2%E7%A9%B6-5%20utils.py/">http://yoursite.com/2020/02/04/deep_learning/yolo/yolov3代码探究-5 utils.py/</a></p>
    <p><strong>This article is available under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)</a> License</strong></p>
</blockquote>


    </article>
    
    <section id="comments">
        
    </section>


    

</main>


<aside style="" id="sidebar" class="aside aside-fixture">
    <div class="toc-sidebar">
        <nav id="toc" class="article-toc">
            <h3 class="toc-title">Catalogue</h3>
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#yolov3%E4%BB%A3%E7%A0%81%E6%8E%A2%E7%A9%B6-5-utils-py"><span class="toc-number">1.</span> <span class="toc-text">yolov3代码探究-5 utils.py</span></a></li></ol>
        </nav>
    </div>
</aside>





        </section>
        <footer class="hidden lg:block fixed bottom-0 left-0 sm:w-1/12 lg:w-1/6 bg-gray-100 z-40">
    
    <div class="footer-social-links">
        
            <a target="_blank" rel="noopener" href="https://github.com/grac-gu">
                <i class="iconfont icon-github"></i>
            </a>
        
            <a href="/None">
                <i class="iconfont icon-telegram"></i>
            </a>
        
            <a href="/None">
                <i class="iconfont icon-twitter"></i>
            </a>
        
            <a href="/atom.xml">
                <i class="iconfont icon-rss"></i>
            </a>
        
    </div>
    
    
</footer>

        <div id="mask" class="hidden mask fixed inset-0 bg-gray-900 opacity-75 z-40"></div>
        <div id="search-view-container" class="hidden shadow-xl"></div>
        
<script src="/js/dom-event.min.js"></script>

<script src="//cdn.jsdelivr.net/npm/yox@1.0.0-alpha.121/dist/standard/prod/yox.min.js"></script>


<script src="/js/search.min.js"></script>



    <script src="//cdn.jsdelivr.net/npm/lightgallery.js@1.1.3/dist/js/lightgallery.min.js"></script>
    
<script src="/js/light-gallery.min.js"></script>





    </body>
</html>
