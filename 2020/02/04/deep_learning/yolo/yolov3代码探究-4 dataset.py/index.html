<!DOCTYPE html>
<html >
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <title>Hexo</title>
    <meta name="description" content="yolov3代码探究-4 dataset.py[TOC] github-yolov3datasets.py 1234567891011121314151617181920212223242526272829303132333435363738import globimport mathimport osimport randomimport shutilfrom pathlib import Pa">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/2020/02/04/deep_learning/yolo/yolov3%E4%BB%A3%E7%A0%81%E6%8E%A2%E7%A9%B6-4%20dataset.py/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="yolov3代码探究-4 dataset.py[TOC] github-yolov3datasets.py 1234567891011121314151617181920212223242526272829303132333435363738import globimport mathimport osimport randomimport shutilfrom pathlib import Pa">
<meta property="og:locale">
<meta property="article:published_time" content="2020-02-04T05:26:23.000Z">
<meta property="article:modified_time" content="2020-02-04T05:26:23.000Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">

    
    <link rel="icon" href="https://i.loli.net/2021/03/04/Y8OtTdUnM4isHxh.jpg" type="image/x-icon">

    
<link rel="stylesheet" href="/css/common.min.css">



    
    
    
    
        <link href="//cdn.jsdelivr.net/npm/lightgallery.js@1.1.3/dist/css/lightgallery.min.css" rel="stylesheet">
    
    
    
<link rel="stylesheet" href="/css/iconfont.min.css">

    
<meta name="generator" content="Hexo 5.4.0"></head>

    <body>
        <header class="header header-fixture">
    <div class="profile-search-wrap flex sm:block">
        
        
        <div class="profile sm:text-center md:px-1 lg:px-3 sm:pb-4 sm:pt-6">
            <a id="avatar" role="link" href="https://github.com/grace-gu" class="inline-block lg:w-16 lg:h-16 w-8 h-8 m-2" target="_blank" rel="noopener" rel="noreferrer" >
                <img src="https://i.loli.net/2021/03/04/Y8OtTdUnM4isHxh.jpg" class="rounded-full" alt="avatar">
            </a>
            <h2 id="name" class="hidden lg:block">Grace</h2>
            <h3 id="title" class="hidden xl:block">coder</h3>
            
            <small id="location" class="hidden lg:block">
                <i class="iconfont icon-map-icon"></i>
                Beijing, China
            </small>
            
        </div>
        
        
<div class="search flex-1 flex lg:inline-block sm:hidden lg:px-4 lg:mt-2 lg:mb-4 lg:w-full">
    <form id="search-form" class="my-auto flex-1 lg:border lg:border-solid lg:border-gray-200">
        <div class="input-group table bg-gray-100 lg:bg-white w-full">
            <input id="search-input" type="text" placeholder="Search" class="inline-block w-full bg-gray-100 lg:bg-white">
            <span class="table-cell">
                <button name="search tigger button" disabled>
                    <i class="iconfont icon-search m-2"></i>
                </button>
            </span>
        </div>
    </form>
        
<script id="search-teamplate" type="text/html" data-path="/content.json">
    <div>
        <div class="search-header bg-gray-400">
            <input id="actual-search-input" model="keyword" ref="input" class="inline-block w-full h-10 px-2 py-1" placeholder="Search" type="text">
        </div>
        <div class="search-result bg-gray-200">
            {{#each searchPosts}}
            <a href="/{{ path }}" class="result-item block px-2 pb-3 mb-1 pt-1 hover:bg-indigo-100">
                <i class="iconfont icon-file"></i>
                <h1 class="result-title inline font-medium text-lg">{{ title }}</h1>
                <p class="result-content text-gray-600 text-sm">{{{ text }}}</p>
            </a>
            {{/each}}
        </div>
    </div>
</script>

</div>


        <button name="menu toogle button" id="menu-toggle-btn" class="block sm:hidden p-3" role="button" aria-expanded="false">
            <i class="iconfont icon-hamburger"></i>
        </button>
    </div>
    <nav id="menu-nav" class="hidden sm:flex flex-col">
        
        
            <div class="menu-item menu-home" role="menuitem">
                <a href="/.">
                    <i class="iconfont icon-home" aria-hidden="true"></i>
                    <span class="menu-title">Home</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-archives" role="menuitem">
                <a href="/archives">
                    <i class="iconfont icon-archive" aria-hidden="true"></i>
                    <span class="menu-title">Archives</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-categories" role="menuitem">
                <a href="/categories">
                    <i class="iconfont icon-folder" aria-hidden="true"></i>
                    <span class="menu-title">Categories</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-tags" role="menuitem">
                <a href="/tags">
                    <i class="iconfont icon-tag" aria-hidden="true"></i>
                    <span class="menu-title">Tags</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-repository" role="menuitem">
                <a href="/repository">
                    <i class="iconfont icon-project" aria-hidden="true"></i>
                    <span class="menu-title">Repository</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-links" role="menuitem">
                <a href="/links">
                    <i class="iconfont icon-friend" aria-hidden="true"></i>
                    <span class="menu-title">Links</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-about" role="menuitem">
                <a href="/about">
                    <i class="iconfont icon-cup" aria-hidden="true"></i>
                    <span class="menu-title">About</span>
                </a>
            </div>
        
        
<div class="social-links flex sm:flex-col lg:hidden mt-5">
    
        <span class="social-item text-center">
            <a target="_blank" rel="noopener" href="https://github.com/grac-gu">
                <i class="iconfont social-icon icon-github"></i>
                <span class="menu-title hidden lg:inline">menu.github</span>
            </a>
        </span>
    
        <span class="social-item text-center">
            <a href="/None">
                <i class="iconfont social-icon icon-telegram"></i>
                <span class="menu-title hidden lg:inline">menu.telegram</span>
            </a>
        </span>
    
        <span class="social-item text-center">
            <a href="/None">
                <i class="iconfont social-icon icon-twitter"></i>
                <span class="menu-title hidden lg:inline">menu.twitter</span>
            </a>
        </span>
    
        <span class="social-item text-center">
            <a href="/atom.xml">
                <i class="iconfont social-icon icon-rss"></i>
                <span class="menu-title hidden lg:inline">menu.rss</span>
            </a>
        </span>
    
</div>


    </nav>
</header>

        <section class="main-section">
            
    <main class="flex-1 px-4 py-12 md:px-5 lg:px-8 lg:py-4 relative min-h-screen">
    

    <article class="content article article-archives article-type-list" itemscope="">
        <header class="article-header">
            


            <p class="article-meta mb-3 text-xs">
                <span class="article-date">
    <i class="iconfont icon-calendar-check"></i>
	<a href="/2020/02/04/deep_learning/yolo/yolov3%E4%BB%A3%E7%A0%81%E6%8E%A2%E7%A9%B6-4%20dataset.py/" class="article-date">
	  <time datetime="2020-02-04T05:26:23.000Z" itemprop="datePublished">Feb 4</time>
	</a>
</span>

                

                

                <span class="_partial/post-comment"><i class="icon icon-comment"></i>
                    <a href="/2020/02/04/deep_learning/yolo/yolov3%E4%BB%A3%E7%A0%81%E6%8E%A2%E7%A9%B6-4%20dataset.py/#comments" class="article-comment-link">
                        Comments
                    </a>
                </span>
                

            </p>
        </header>
        <div class="marked-body article-body">
            <h1 id="yolov3代码探究-4-dataset-py"><a href="#yolov3代码探究-4-dataset-py" class="headerlink" title="yolov3代码探究-4 dataset.py"></a>yolov3代码探究-4 dataset.py</h1><p>[TOC]</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ultralytics/yolov3">github-yolov3</a><br><a target="_blank" rel="noopener" href="https://github.com/ultralytics/yolov3/blob/master/utils/datasets.py">datasets.py</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> Dataset</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ExifTags</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.utils <span class="keyword">import</span> xyxy2xywh, xywh2xyxy</span><br><span class="line"></span><br><span class="line">img_formats = [<span class="string">&#x27;.bmp&#x27;</span>, <span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.jpeg&#x27;</span>, <span class="string">&#x27;.png&#x27;</span>, <span class="string">&#x27;.tif&#x27;</span>]</span><br><span class="line">vid_formats = [<span class="string">&#x27;.mov&#x27;</span>, <span class="string">&#x27;.avi&#x27;</span>, <span class="string">&#x27;.mp4&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get orientation exif tag</span></span><br><span class="line"><span class="keyword">for</span> orientation <span class="keyword">in</span> ExifTags.TAGS.keys():</span><br><span class="line">    <span class="keyword">if</span> ExifTags.TAGS[orientation] == <span class="string">&#x27;Orientation&#x27;</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exif_size</span>(<span class="params">img</span>):</span></span><br><span class="line">    <span class="comment"># Returns exif-corrected PIL size</span></span><br><span class="line">    s = img.size  <span class="comment"># (width, height)</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        rotation = <span class="built_in">dict</span>(img._getexif().items())[orientation]</span><br><span class="line">        <span class="keyword">if</span> rotation == <span class="number">6</span>:  <span class="comment"># rotation 270</span></span><br><span class="line">            s = (s[<span class="number">1</span>], s[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">elif</span> rotation == <span class="number">8</span>:  <span class="comment"># rotation 90</span></span><br><span class="line">            s = (s[<span class="number">1</span>], s[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> s</span><br></pre></td></tr></table></figure>
<p>&nbsp;<br>loadImages用在detect.py里</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoadImages</span>:</span>  <span class="comment"># for inference</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, path, img_size=<span class="number">416</span></span>):</span></span><br><span class="line">        self.height = img_size</span><br><span class="line"></span><br><span class="line">        files = []</span><br><span class="line">        <span class="keyword">if</span> os.path.isdir(path):</span><br><span class="line">            files = <span class="built_in">sorted</span>(glob.glob(<span class="string">&#x27;%s/*.*&#x27;</span> % path))</span><br><span class="line">        <span class="keyword">elif</span> os.path.isfile(path):</span><br><span class="line">            files = [path]</span><br><span class="line"></span><br><span class="line">        images = [x <span class="keyword">for</span> x <span class="keyword">in</span> files <span class="keyword">if</span> os.path.splitext(x)[-<span class="number">1</span>].lower() <span class="keyword">in</span> img_formats]</span><br><span class="line">        videos = [x <span class="keyword">for</span> x <span class="keyword">in</span> files <span class="keyword">if</span> os.path.splitext(x)[-<span class="number">1</span>].lower() <span class="keyword">in</span> vid_formats]</span><br><span class="line">        nI, nV = <span class="built_in">len</span>(images), <span class="built_in">len</span>(videos)</span><br><span class="line"></span><br><span class="line">        self.files = images + videos</span><br><span class="line">        self.nF = nI + nV  <span class="comment"># number of files</span></span><br><span class="line">        self.video_flag = [<span class="literal">False</span>] * nI + [<span class="literal">True</span>] * nV</span><br><span class="line">        self.mode = <span class="string">&#x27;images&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">any</span>(videos):</span><br><span class="line">            self.new_video(videos[<span class="number">0</span>])  <span class="comment"># new video</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.cap = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">assert</span> self.nF &gt; <span class="number">0</span>, <span class="string">&#x27;No images or videos found in &#x27;</span> + path</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__next__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.count == self.nF:</span><br><span class="line">            <span class="keyword">raise</span> StopIteration</span><br><span class="line">        path = self.files[self.count]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.video_flag[self.count]:</span><br><span class="line">            <span class="comment"># Read video</span></span><br><span class="line">            self.mode = <span class="string">&#x27;video&#x27;</span></span><br><span class="line">            ret_val, img0 = self.cap.read()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ret_val:</span><br><span class="line">                self.count += <span class="number">1</span></span><br><span class="line">                self.cap.release()</span><br><span class="line">                <span class="keyword">if</span> self.count == self.nF:  <span class="comment"># last video</span></span><br><span class="line">                    <span class="keyword">raise</span> StopIteration</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    path = self.files[self.count]</span><br><span class="line">                    self.new_video(path)</span><br><span class="line">                    ret_val, img0 = self.cap.read()</span><br><span class="line"></span><br><span class="line">            self.frame += <span class="number">1</span></span><br><span class="line">            print(<span class="string">&#x27;video %g/%g (%g/%g) %s: &#x27;</span> % (self.count + <span class="number">1</span>, self.nF, self.frame, self.nframes, path), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># Read image</span></span><br><span class="line">            self.count += <span class="number">1</span></span><br><span class="line">            img0 = cv2.imread(path)  <span class="comment"># BGR</span></span><br><span class="line">            <span class="keyword">assert</span> img0 <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>, <span class="string">&#x27;File Not Found &#x27;</span> + path</span><br><span class="line">            print(<span class="string">&#x27;image %g/%g %s: &#x27;</span> % (self.count, self.nF, path), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Padded resize</span></span><br><span class="line">        img, *_ = letterbox(img0, new_shape=self.height)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Normalize RGB</span></span><br><span class="line">        img = img[:, :, ::-<span class="number">1</span>].transpose(<span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>)  <span class="comment"># BGR to RGB</span></span><br><span class="line">        img = np.ascontiguousarray(img, dtype=np.float32)  <span class="comment"># uint8 to float32</span></span><br><span class="line">        img /= <span class="number">255.0</span>  <span class="comment"># 0 - 255 to 0.0 - 1.0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># cv2.imwrite(path + &#x27;.letterbox.jpg&#x27;, 255 * img.transpose((1, 2, 0))[:, :, ::-1])  # save letterbox image</span></span><br><span class="line">        <span class="keyword">return</span> path, img, img0, self.cap</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">new_video</span>(<span class="params">self, path</span>):</span></span><br><span class="line">        self.frame = <span class="number">0</span></span><br><span class="line">        self.cap = cv2.VideoCapture(path)</span><br><span class="line">        self.nframes = <span class="built_in">int</span>(self.cap.get(cv2.CAP_PROP_FRAME_COUNT))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.nF  <span class="comment"># number of files</span></span><br></pre></td></tr></table></figure>

<p>&nbsp;<br>webcam指网络摄像头，所以这边应该是指视频。也是用在detect.py中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoadWebcam</span>:</span>  <span class="comment"># for inference</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, img_size=<span class="number">416</span></span>):</span></span><br><span class="line">        self.cam = cv2.VideoCapture(<span class="number">0</span>)</span><br><span class="line">        self.height = img_size</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.count = -<span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__next__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> cv2.waitKey(<span class="number">1</span>) == <span class="number">27</span>:  <span class="comment"># esc to quit</span></span><br><span class="line">            cv2.destroyAllWindows()</span><br><span class="line">            <span class="keyword">raise</span> StopIteration</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Read image</span></span><br><span class="line">        ret_val, img0 = self.cam.read()</span><br><span class="line">        <span class="keyword">assert</span> ret_val, <span class="string">&#x27;Webcam Error&#x27;</span></span><br><span class="line">        img_path = <span class="string">&#x27;webcam_%g.jpg&#x27;</span> % self.count</span><br><span class="line">        img0 = cv2.flip(img0, <span class="number">1</span>)  <span class="comment"># flip left-right</span></span><br><span class="line">        print(<span class="string">&#x27;webcam %g: &#x27;</span> % self.count, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Padded resize</span></span><br><span class="line">        img, *_ = letterbox(img0, new_shape=self.height)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Normalize RGB</span></span><br><span class="line">        img = img[:, :, ::-<span class="number">1</span>].transpose(<span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>)  <span class="comment"># BGR to RGB</span></span><br><span class="line">        img = np.ascontiguousarray(img, dtype=np.float32)  <span class="comment"># uint8 to float32</span></span><br><span class="line">        img /= <span class="number">255.0</span>  <span class="comment"># 0 - 255 to 0.0 - 1.0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> img_path, img, img0, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>&nbsp;<br>LoadImagesAndLabels用于加载训练用的数据集<br>这里需要特别注意一下<code>collate_fn</code>函数，我的理解相当于这是个后处理<br>这边比较重要，做一个流程梳理。</p>
<ol>
<li><code>__init__</code>:<br>初始化，获取关于图像的信息、标注文件的信息</li>
<li><code>__getitem__</code>:<br>按照init的内容依次读取图像，做处理（三通道处理、像素放到0-1之间）后成为tensor;<br>读取标注文件，假设一张图中有num_of_lables(an image)个标注信息，则返回的labels_out是一个(num_of_lables(an image), 6)的矩阵， 每行的信息包括: [空(后续是用来填图像ID的), class_id, x, y, w, h]</li>
<li><code>collate_fn</code>:<br>实现自定义的batch输出，它把每个batch中的labels（上文的labels_out）取出来，在<code>空</code>的位置加上图像id, 并做拼接</li>
</ol>
<p><strong>问题</strong></p>
<ul>
<li>[x]它这边处理labels时先是xyxy2xywh，再做了个归一化。而我在生成数据集时应该是已经处理过了的，但从当时的训练结果来看并没有问题，为什么会这样<br>作者这边的代码先是xywh2xyxy，他加了些关于padding的操作，再xyxy2xywh,所以我的数据集没啥问题<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoadImagesAndLabels</span>(<span class="params">Dataset</span>):</span>  <span class="comment"># for training/testing</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, path, img_size=<span class="number">416</span>, batch_size=<span class="number">16</span>, augment=<span class="literal">False</span>, rect=<span class="literal">True</span>, image_weights=<span class="literal">False</span></span>):</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            img_files = f.read().splitlines()</span><br><span class="line">            self.img_files = [x <span class="keyword">for</span> x <span class="keyword">in</span> img_files <span class="keyword">if</span> os.path.splitext(x)[-<span class="number">1</span>].lower() <span class="keyword">in</span> img_formats]</span><br><span class="line"></span><br><span class="line">        n = <span class="built_in">len</span>(self.img_files)</span><br><span class="line">        bi = np.floor(np.arange(n) / batch_size).astype(np.<span class="built_in">int</span>)  <span class="comment"># batch index</span></span><br><span class="line">        nb = bi[-<span class="number">1</span>] + <span class="number">1</span>  <span class="comment"># number of batches</span></span><br><span class="line">        <span class="keyword">assert</span> n &gt; <span class="number">0</span>, <span class="string">&#x27;No images found in %s&#x27;</span> % path</span><br><span class="line"></span><br><span class="line">        self.n = n</span><br><span class="line">        self.batch = bi  <span class="comment"># batch index of image</span></span><br><span class="line">        self.img_size = img_size</span><br><span class="line">        self.augment = augment</span><br><span class="line">        self.image_weights = image_weights</span><br><span class="line">        self.rect = <span class="literal">False</span> <span class="keyword">if</span> image_weights <span class="keyword">else</span> rect</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Define labels</span></span><br><span class="line">        self.label_files = [x.replace(<span class="string">&#x27;images&#x27;</span>, <span class="string">&#x27;labels&#x27;</span>).replace(os.path.splitext(x)[-<span class="number">1</span>], <span class="string">&#x27;.txt&#x27;</span>)</span><br><span class="line">                            <span class="keyword">for</span> x <span class="keyword">in</span> self.img_files]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Rectangular Training  https://github.com/ultralytics/yolov3/issues/232</span></span><br><span class="line">        <span class="keyword">if</span> self.rect:</span><br><span class="line">            <span class="comment"># Read image shapes</span></span><br><span class="line">            sp = <span class="string">&#x27;data&#x27;</span> + os.sep + path.replace(<span class="string">&#x27;.txt&#x27;</span>, <span class="string">&#x27;.shapes&#x27;</span>).split(os.sep)[-<span class="number">1</span>]  <span class="comment"># shapefile path</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(sp):  <span class="comment"># read shapes using PIL and write shapefile for next time (faster)</span></span><br><span class="line">                s = [exif_size(Image.<span class="built_in">open</span>(f)) <span class="keyword">for</span> f <span class="keyword">in</span> tqdm(self.img_files, desc=<span class="string">&#x27;Reading image shapes&#x27;</span>)]</span><br><span class="line">                np.savetxt(sp, s, fmt=<span class="string">&#x27;%g&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(sp, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:  <span class="comment"># read existing shapefile</span></span><br><span class="line">                    s = np.array([x.split() <span class="keyword">for</span> x <span class="keyword">in</span> f.read().splitlines()], dtype=np.float64)</span><br><span class="line">                    <span class="keyword">assert</span> <span class="built_in">len</span>(s) == n, <span class="string">&#x27;Shapefile out of sync&#x27;</span></span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                os.remove(sp)</span><br><span class="line">                print(<span class="string">&#x27;Shapefile deleted: %s. Please rerun again.&#x27;</span> % sp)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Sort by aspect ratio</span></span><br><span class="line">            ar = s[:, <span class="number">1</span>] / s[:, <span class="number">0</span>]  <span class="comment"># aspect ratio</span></span><br><span class="line">            i = ar.argsort()</span><br><span class="line">            self.img_files = [self.img_files[i] <span class="keyword">for</span> i <span class="keyword">in</span> i]</span><br><span class="line">            self.label_files = [self.label_files[i] <span class="keyword">for</span> i <span class="keyword">in</span> i]</span><br><span class="line">            ar = ar[i]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Set training image shapes</span></span><br><span class="line">            shapes = [[<span class="number">1</span>, <span class="number">1</span>]] * nb</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(nb):</span><br><span class="line">                ari = ar[bi == i]</span><br><span class="line">                mini, maxi = ari.<span class="built_in">min</span>(), ari.<span class="built_in">max</span>()</span><br><span class="line">                <span class="keyword">if</span> maxi &lt; <span class="number">1</span>:</span><br><span class="line">                    shapes[i] = [maxi, <span class="number">1</span>]</span><br><span class="line">                <span class="keyword">elif</span> mini &gt; <span class="number">1</span>:</span><br><span class="line">                    shapes[i] = [<span class="number">1</span>, <span class="number">1</span> / mini]</span><br><span class="line"></span><br><span class="line">            self.batch_shapes = np.ceil(np.array(shapes) * img_size / <span class="number">32.</span>).astype(np.<span class="built_in">int</span>) * <span class="number">32</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Preload labels (required for weighted CE training)</span></span><br><span class="line">        self.imgs = [<span class="literal">None</span>] * n</span><br><span class="line">        self.labels = [<span class="literal">None</span>] * n</span><br><span class="line">        preload_labels = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> preload_labels:</span><br><span class="line">            self.labels = [np.zeros((<span class="number">0</span>, <span class="number">5</span>))] * n</span><br><span class="line">            <span class="built_in">iter</span> = tqdm(self.label_files, desc=<span class="string">&#x27;Reading labels&#x27;</span>) <span class="keyword">if</span> n &gt; <span class="number">10</span> <span class="keyword">else</span> self.label_files</span><br><span class="line">            extract_bounding_boxes = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">for</span> i, file <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="built_in">iter</span>):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">with</span> <span class="built_in">open</span>(file, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                        l = np.array([x.split() <span class="keyword">for</span> x <span class="keyword">in</span> f.read().splitlines()], dtype=np.float32)</span><br><span class="line">                        <span class="keyword">if</span> l.shape[<span class="number">0</span>]:</span><br><span class="line">                            <span class="keyword">assert</span> l.shape[<span class="number">1</span>] == <span class="number">5</span>, <span class="string">&#x27;&gt; 5 label columns: %s&#x27;</span> % file</span><br><span class="line">                            <span class="keyword">assert</span> (l &gt;= <span class="number">0</span>).<span class="built_in">all</span>(), <span class="string">&#x27;negative labels: %s&#x27;</span> % file</span><br><span class="line">                            <span class="keyword">assert</span> (l[:, <span class="number">1</span>:] &lt;= <span class="number">1</span>).<span class="built_in">all</span>(), <span class="string">&#x27;non-normalized or out of bounds coordinate labels: %s&#x27;</span> % file</span><br><span class="line">                            self.labels[i] = l</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># Extract object detection boxes for a second stage classifier</span></span><br><span class="line">                            <span class="keyword">if</span> extract_bounding_boxes:</span><br><span class="line">                                p = Path(self.img_files[i])</span><br><span class="line">                                img = cv2.imread(<span class="built_in">str</span>(p))</span><br><span class="line">                                h, w, _ = img.shape</span><br><span class="line">                                <span class="keyword">for</span> j, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(l):</span><br><span class="line">                                    f = <span class="string">&#x27;%s%sclassification%s%g_%g_%s&#x27;</span> % (</span><br><span class="line">                                        p.parent.parent, os.sep, os.sep, x[<span class="number">0</span>], j, p.name)</span><br><span class="line">                                    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(Path(f).parent):</span><br><span class="line">                                        os.makedirs(Path(f).parent)  <span class="comment"># make new output folder</span></span><br><span class="line">                                    box = xywh2xyxy(x[<span class="number">1</span>:].reshape(-<span class="number">1</span>, <span class="number">4</span>)).ravel()</span><br><span class="line">                                    box = np.clip(box, <span class="number">0</span>, <span class="number">1</span>)  <span class="comment"># clip boxes outside of image</span></span><br><span class="line">                                    result = cv2.imwrite(f, img[<span class="built_in">int</span>(box[<span class="number">1</span>] * h):<span class="built_in">int</span>(box[<span class="number">3</span>] * h),</span><br><span class="line">                                                            <span class="built_in">int</span>(box[<span class="number">0</span>] * w):<span class="built_in">int</span>(box[<span class="number">2</span>] * w)])</span><br><span class="line">                                    <span class="keyword">if</span> <span class="keyword">not</span> result:</span><br><span class="line">                                        print(<span class="string">&#x27;stop&#x27;</span>)</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    <span class="keyword">pass</span>  <span class="comment"># print(&#x27;Warning: missing labels for %s&#x27; % self.img_files[i])  # missing label file</span></span><br><span class="line">            <span class="keyword">assert</span> <span class="built_in">len</span>(np.concatenate(self.labels, <span class="number">0</span>)) &gt; <span class="number">0</span>, <span class="string">&#x27;No labels found. Incorrect label paths provided.&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Detect corrupted images https://medium.com/joelthchao/programmatically-detect-corrupted-image-8c1b2006c3d3</span></span><br><span class="line">        detect_corrupted_images = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> detect_corrupted_images:</span><br><span class="line">            <span class="keyword">from</span> skimage <span class="keyword">import</span> io  <span class="comment"># conda install -c conda-forge scikit-image</span></span><br><span class="line">            <span class="keyword">for</span> file <span class="keyword">in</span> tqdm(self.img_files, desc=<span class="string">&#x27;Detecting corrupted images&#x27;</span>):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    _ = io.imread(file)</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    print(<span class="string">&#x27;Corrupted image detected: %s&#x27;</span> % file)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.img_files)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># def __iter__(self):</span></span><br><span class="line">    <span class="comment">#     self.count = -1</span></span><br><span class="line">    <span class="comment">#     print(&#x27;ran dataset iter&#x27;)</span></span><br><span class="line">    <span class="comment">#     #self.shuffled_vector = np.random.permutation(self.nF) if self.augment else np.arange(self.nF)</span></span><br><span class="line">    <span class="comment">#     return self</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span>(<span class="params">self, index</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.image_weights:</span><br><span class="line">            index = self.indices[index]</span><br><span class="line"></span><br><span class="line">        img_path = self.img_files[index]</span><br><span class="line">        label_path = self.label_files[index]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Load image</span></span><br><span class="line">        img = self.imgs[index]</span><br><span class="line">        <span class="keyword">if</span> img <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            img = cv2.imread(img_path)  <span class="comment"># BGR</span></span><br><span class="line">            <span class="keyword">assert</span> img <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>, <span class="string">&#x27;File Not Found &#x27;</span> + img_path</span><br><span class="line">            <span class="keyword">if</span> self.n &lt; <span class="number">1001</span>:</span><br><span class="line">                self.imgs[index] = img  <span class="comment"># cache image into memory</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 我这边是一个一通道图像，黑白图，颜色增强没用，所以可以把augment_hsv置为False</span></span><br><span class="line">        <span class="comment"># Augment colorspace</span></span><br><span class="line">        augment_hsv = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> self.augment <span class="keyword">and</span> augment_hsv:</span><br><span class="line">            <span class="comment"># SV augmentation by 50%</span></span><br><span class="line">            fraction = <span class="number">0.50</span>  <span class="comment"># must be &lt; 1.0</span></span><br><span class="line">            img_hsv = cv2.cvtColor(img, cv2.COLOR_BGR2HSV)  <span class="comment"># hue, sat, val</span></span><br><span class="line">            S = img_hsv[:, :, <span class="number">1</span>].astype(np.float32)  <span class="comment"># saturation</span></span><br><span class="line">            V = img_hsv[:, :, <span class="number">2</span>].astype(np.float32)  <span class="comment"># value</span></span><br><span class="line"></span><br><span class="line">            a = (random.random() * <span class="number">2</span> - <span class="number">1</span>) * fraction + <span class="number">1</span></span><br><span class="line">            b = (random.random() * <span class="number">2</span> - <span class="number">1</span>) * fraction + <span class="number">1</span></span><br><span class="line">            S *= a</span><br><span class="line">            V *= b</span><br><span class="line"></span><br><span class="line">            img_hsv[:, :, <span class="number">1</span>] = S <span class="keyword">if</span> a &lt; <span class="number">1</span> <span class="keyword">else</span> S.clip(<span class="literal">None</span>, <span class="number">255</span>)</span><br><span class="line">            img_hsv[:, :, <span class="number">2</span>] = V <span class="keyword">if</span> b &lt; <span class="number">1</span> <span class="keyword">else</span> V.clip(<span class="literal">None</span>, <span class="number">255</span>)</span><br><span class="line">            cv2.cvtColor(img_hsv, cv2.COLOR_HSV2BGR, dst=img)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Letterbox</span></span><br><span class="line">        h, w, _ = img.shape</span><br><span class="line">        <span class="keyword">if</span> self.rect:</span><br><span class="line">            shape = self.batch_shapes[self.batch[index]]</span><br><span class="line">            img, ratiow, ratioh, padw, padh = letterbox(img, new_shape=shape, mode=<span class="string">&#x27;rect&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            shape = self.img_size</span><br><span class="line">            img, ratiow, ratioh, padw, padh = letterbox(img, new_shape=shape, mode=<span class="string">&#x27;square&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Load labels</span></span><br><span class="line">        labels = []</span><br><span class="line">        <span class="keyword">if</span> os.path.isfile(label_path):</span><br><span class="line">            x = self.labels[index]</span><br><span class="line">            <span class="keyword">if</span> x <span class="keyword">is</span> <span class="literal">None</span>:  <span class="comment"># labels not preloaded</span></span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(label_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    x = np.array([x.split() <span class="keyword">for</span> x <span class="keyword">in</span> f.read().splitlines()], dtype=np.float32)</span><br><span class="line">                    self.labels[index] = x  <span class="comment"># save for next time</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> x.size &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># Normalized xywh to pixel xyxy format</span></span><br><span class="line">                labels = x.copy()</span><br><span class="line">                labels[:, <span class="number">1</span>] = ratiow * w * (x[:, <span class="number">1</span>] - x[:, <span class="number">3</span>] / <span class="number">2</span>) + padw</span><br><span class="line">                labels[:, <span class="number">2</span>] = ratioh * h * (x[:, <span class="number">2</span>] - x[:, <span class="number">4</span>] / <span class="number">2</span>) + padh</span><br><span class="line">                labels[:, <span class="number">3</span>] = ratiow * w * (x[:, <span class="number">1</span>] + x[:, <span class="number">3</span>] / <span class="number">2</span>) + padw</span><br><span class="line">                labels[:, <span class="number">4</span>] = ratioh * h * (x[:, <span class="number">2</span>] + x[:, <span class="number">4</span>] / <span class="number">2</span>) + padh</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Augment image and labels</span></span><br><span class="line">        <span class="keyword">if</span> self.augment:</span><br><span class="line">            img, labels = random_affine(img, labels, degrees=(-<span class="number">5</span>, <span class="number">5</span>), translate=(<span class="number">0.10</span>, <span class="number">0.10</span>), scale=(<span class="number">0.90</span>, <span class="number">1.10</span>))</span><br><span class="line"></span><br><span class="line">        nL = <span class="built_in">len</span>(labels)  <span class="comment"># number of labels</span></span><br><span class="line">        <span class="keyword">if</span> nL:</span><br><span class="line">            <span class="comment"># convert xyxy to xywh</span></span><br><span class="line">            labels[:, <span class="number">1</span>:<span class="number">5</span>] = xyxy2xywh(labels[:, <span class="number">1</span>:<span class="number">5</span>])</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Normalize coordinates 0 - 1</span></span><br><span class="line">            labels[:, [<span class="number">2</span>, <span class="number">4</span>]] /= img.shape[<span class="number">0</span>]  <span class="comment"># height</span></span><br><span class="line">            labels[:, [<span class="number">1</span>, <span class="number">3</span>]] /= img.shape[<span class="number">1</span>]  <span class="comment"># width</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 这里考虑做随机翻转，用来数据集增广</span></span><br><span class="line">        <span class="keyword">if</span> self.augment:</span><br><span class="line">            <span class="comment"># random left-right flip</span></span><br><span class="line">            lr_flip = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">if</span> lr_flip <span class="keyword">and</span> random.random() &gt; <span class="number">0.5</span>:</span><br><span class="line">                img = np.fliplr(img)</span><br><span class="line">                <span class="keyword">if</span> nL:</span><br><span class="line">                    labels[:, <span class="number">1</span>] = <span class="number">1</span> - labels[:, <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># random up-down flip</span></span><br><span class="line">            ud_flip = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">if</span> ud_flip <span class="keyword">and</span> random.random() &gt; <span class="number">0.5</span>:</span><br><span class="line">                img = np.flipud(img)</span><br><span class="line">                <span class="keyword">if</span> nL:</span><br><span class="line">                    labels[:, <span class="number">2</span>] = <span class="number">1</span> - labels[:, <span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">        labels_out = torch.zeros((nL, <span class="number">6</span>))</span><br><span class="line">        <span class="keyword">if</span> nL:</span><br><span class="line">            labels_out[:, <span class="number">1</span>:] = torch.from_numpy(labels)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Normalize</span></span><br><span class="line">        img = img[:, :, ::-<span class="number">1</span>].transpose(<span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>)  <span class="comment"># BGR to RGB, to 3x416x416</span></span><br><span class="line">        img = np.ascontiguousarray(img, dtype=np.float32)  <span class="comment"># uint8 to float32</span></span><br><span class="line">        img /= <span class="number">255.0</span>  <span class="comment"># 0 - 255 to 0.0 - 1.0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> torch.from_numpy(img), labels_out, img_path, (h, w)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">collate_fn</span>(<span class="params">batch</span>):</span></span><br><span class="line">        img, label, path, hw = <span class="built_in">list</span>(<span class="built_in">zip</span>(*batch))  <span class="comment"># transposed</span></span><br><span class="line">        <span class="keyword">for</span> i, l <span class="keyword">in</span> <span class="built_in">enumerate</span>(label):</span><br><span class="line">            l[:, <span class="number">0</span>] = i  <span class="comment"># add target image index for build_targets()</span></span><br><span class="line">        <span class="comment"># torch.stack(img, 0): 增加维度</span></span><br><span class="line">        <span class="comment"># torch.cat(label, 0): 元素拼接。 将labels按行拼接      </span></span><br><span class="line">        <span class="keyword">return</span> torch.stack(img, <span class="number">0</span>), torch.cat(label, <span class="number">0</span>), path, hw</span><br></pre></td></tr></table></figure>
基于上文代码做一个维度梳理。</li>
</ul>
<ol>
<li>img维度推算如下</li>
</ol>
<ul>
<li><code>__getItem__</code>中，返回维度是(3, 416, 416)</li>
<li><code>collate_fn</code>中，torch.stack维度(nums_of_images, 3, 416, 416)，作用是把原来一个个的img的list拼成一个大的list</li>
</ul>
<ol start="2">
<li>label维度推算如下</li>
</ol>
<ul>
<li><code>__getitem__</code>中，维度是(num_of_labels(one images), 6)</li>
<li><code>collate_fn</code>中，torch.cat后维度是(num_of_labels(all images), 6)<br>看到这里就明白了它是怎么维度统一的了，它将所有的label一个个排列了，而不是把用一个个list结构放到一个总的list中。<br>label的结构[image_id, class, x, y, w, h] ，其中的image_id用来存储这条标注到底是哪张图的（这个工作在collate_fn中完成）</li>
</ul>
<p>&nbsp;<br>这里划一下看代码时候学到的知识。</p>
<ol>
<li>torch.stack(img, dims=0): 增加维度。dims:在哪个维度叠加。<a target="_blank" rel="noopener" href="https://www.cnblogs.com/yifdu25/p/9399047.html">pytorch中的cat、stack、tranpose、permute、unsqeeze</a></li>
</ol>
<p>&nbsp;<br><strong>问题引申</strong></p>
<ul>
<li>[x]为什么要在collate_fn中标记label所属图像，直接在__getitem__中加一个labels_out[:, 0] = index不可以吗。需要测试<br>不可以，可以发现collate_fn是针对每一个batch重新编号的，如果是labels_out[:, 0] = index那就是针对所有数据集编号了</li>
</ul>
<p>&nbsp;<br>这边暂时用不上，代码没看</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">letterbox</span>(<span class="params">img, new_shape=<span class="number">416</span>, color=(<span class="params"><span class="number">127.5</span>, <span class="number">127.5</span>, <span class="number">127.5</span></span>), mode=<span class="string">&#x27;auto&#x27;</span></span>):</span></span><br><span class="line">    <span class="comment"># Resize a rectangular image to a 32 pixel multiple rectangle</span></span><br><span class="line">    <span class="comment"># https://github.com/ultralytics/yolov3/issues/232</span></span><br><span class="line">    shape = img.shape[:<span class="number">2</span>]  <span class="comment"># current shape [height, width]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(new_shape, <span class="built_in">int</span>):</span><br><span class="line">        ratio = <span class="built_in">float</span>(new_shape) / <span class="built_in">max</span>(shape)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ratio = <span class="built_in">max</span>(new_shape) / <span class="built_in">max</span>(shape)  <span class="comment"># ratio  = new / old</span></span><br><span class="line">    ratiow, ratioh = ratio, ratio</span><br><span class="line">    new_unpad = (<span class="built_in">int</span>(<span class="built_in">round</span>(shape[<span class="number">1</span>] * ratio)), <span class="built_in">int</span>(<span class="built_in">round</span>(shape[<span class="number">0</span>] * ratio)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Compute padding https://github.com/ultralytics/yolov3/issues/232</span></span><br><span class="line">    <span class="keyword">if</span> mode <span class="keyword">is</span> <span class="string">&#x27;auto&#x27;</span>:  <span class="comment"># minimum rectangle</span></span><br><span class="line">        dw = np.mod(new_shape - new_unpad[<span class="number">0</span>], <span class="number">32</span>) / <span class="number">2</span>  <span class="comment"># width padding</span></span><br><span class="line">        dh = np.mod(new_shape - new_unpad[<span class="number">1</span>], <span class="number">32</span>) / <span class="number">2</span>  <span class="comment"># height padding</span></span><br><span class="line">    <span class="keyword">elif</span> mode <span class="keyword">is</span> <span class="string">&#x27;square&#x27;</span>:  <span class="comment"># square</span></span><br><span class="line">        dw = (new_shape - new_unpad[<span class="number">0</span>]) / <span class="number">2</span>  <span class="comment"># width padding</span></span><br><span class="line">        dh = (new_shape - new_unpad[<span class="number">1</span>]) / <span class="number">2</span>  <span class="comment"># height padding</span></span><br><span class="line">    <span class="keyword">elif</span> mode <span class="keyword">is</span> <span class="string">&#x27;rect&#x27;</span>:  <span class="comment"># square</span></span><br><span class="line">        dw = (new_shape[<span class="number">1</span>] - new_unpad[<span class="number">0</span>]) / <span class="number">2</span>  <span class="comment"># width padding</span></span><br><span class="line">        dh = (new_shape[<span class="number">0</span>] - new_unpad[<span class="number">1</span>]) / <span class="number">2</span>  <span class="comment"># height padding</span></span><br><span class="line">    <span class="keyword">elif</span> mode <span class="keyword">is</span> <span class="string">&#x27;scaleFill&#x27;</span>:</span><br><span class="line">        dw, dh = <span class="number">0.0</span>, <span class="number">0.0</span></span><br><span class="line">        new_unpad = (new_shape, new_shape)</span><br><span class="line">        ratiow, ratioh = new_shape / shape[<span class="number">1</span>], new_shape / shape[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    top, bottom = <span class="built_in">int</span>(<span class="built_in">round</span>(dh - <span class="number">0.1</span>)), <span class="built_in">int</span>(<span class="built_in">round</span>(dh + <span class="number">0.1</span>))</span><br><span class="line">    left, right = <span class="built_in">int</span>(<span class="built_in">round</span>(dw - <span class="number">0.1</span>)), <span class="built_in">int</span>(<span class="built_in">round</span>(dw + <span class="number">0.1</span>))</span><br><span class="line">    img = cv2.resize(img, new_unpad, interpolation=cv2.INTER_AREA)  <span class="comment"># resized, no border</span></span><br><span class="line">    img = cv2.copyMakeBorder(img, top, bottom, left, right, cv2.BORDER_CONSTANT, value=color)  <span class="comment"># padded square</span></span><br><span class="line">    <span class="keyword">return</span> img, ratiow, ratioh, dw, dh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">random_affine</span>(<span class="params">img, targets=(<span class="params"></span>), degrees=(<span class="params">-<span class="number">10</span>, <span class="number">10</span></span>), translate=(<span class="params"><span class="number">.1</span>, <span class="number">.1</span></span>), scale=(<span class="params"><span class="number">.9</span>, <span class="number">1.1</span></span>), shear=(<span class="params">-<span class="number">2</span>, <span class="number">2</span></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">                  borderValue=(<span class="params"><span class="number">127.5</span>, <span class="number">127.5</span>, <span class="number">127.5</span></span>)</span>):</span></span><br><span class="line">    <span class="comment"># torchvision.transforms.RandomAffine(degrees=(-10, 10), translate=(.1, .1), scale=(.9, 1.1), shear=(-10, 10))</span></span><br><span class="line">    <span class="comment"># https://medium.com/uruvideo/dataset-augmentation-with-random-homographies-a8f4b44830d4</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> targets <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        targets = []</span><br><span class="line">    border = <span class="number">0</span>  <span class="comment"># width of added border (optional)</span></span><br><span class="line">    height = img.shape[<span class="number">0</span>] + border * <span class="number">2</span></span><br><span class="line">    width = img.shape[<span class="number">1</span>] + border * <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Rotation and Scale</span></span><br><span class="line">    R = np.eye(<span class="number">3</span>)</span><br><span class="line">    a = random.random() * (degrees[<span class="number">1</span>] - degrees[<span class="number">0</span>]) + degrees[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># a += random.choice([-180, -90, 0, 90])  # 90deg rotations added to small rotations</span></span><br><span class="line">    s = random.random() * (scale[<span class="number">1</span>] - scale[<span class="number">0</span>]) + scale[<span class="number">0</span>]</span><br><span class="line">    R[:<span class="number">2</span>] = cv2.getRotationMatrix2D(angle=a, center=(img.shape[<span class="number">1</span>] / <span class="number">2</span>, img.shape[<span class="number">0</span>] / <span class="number">2</span>), scale=s)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Translation</span></span><br><span class="line">    T = np.eye(<span class="number">3</span>)</span><br><span class="line">    T[<span class="number">0</span>, <span class="number">2</span>] = (random.random() * <span class="number">2</span> - <span class="number">1</span>) * translate[<span class="number">0</span>] * img.shape[<span class="number">0</span>] + border  <span class="comment"># x translation (pixels)</span></span><br><span class="line">    T[<span class="number">1</span>, <span class="number">2</span>] = (random.random() * <span class="number">2</span> - <span class="number">1</span>) * translate[<span class="number">1</span>] * img.shape[<span class="number">1</span>] + border  <span class="comment"># y translation (pixels)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Shear</span></span><br><span class="line">    S = np.eye(<span class="number">3</span>)</span><br><span class="line">    S[<span class="number">0</span>, <span class="number">1</span>] = math.tan((random.random() * (shear[<span class="number">1</span>] - shear[<span class="number">0</span>]) + shear[<span class="number">0</span>]) * math.pi / <span class="number">180</span>)  <span class="comment"># x shear (deg)</span></span><br><span class="line">    S[<span class="number">1</span>, <span class="number">0</span>] = math.tan((random.random() * (shear[<span class="number">1</span>] - shear[<span class="number">0</span>]) + shear[<span class="number">0</span>]) * math.pi / <span class="number">180</span>)  <span class="comment"># y shear (deg)</span></span><br><span class="line"></span><br><span class="line">    M = S @ T @ R  <span class="comment"># Combined rotation matrix. ORDER IS IMPORTANT HERE!!</span></span><br><span class="line">    imw = cv2.warpAffine(img, M[:<span class="number">2</span>], dsize=(width, height), flags=cv2.INTER_AREA,</span><br><span class="line">                         borderValue=borderValue)  <span class="comment"># BGR order borderValue</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Return warped points also</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(targets) &gt; <span class="number">0</span>:</span><br><span class="line">        n = targets.shape[<span class="number">0</span>]</span><br><span class="line">        points = targets[:, <span class="number">1</span>:<span class="number">5</span>].copy()</span><br><span class="line">        area0 = (points[:, <span class="number">2</span>] - points[:, <span class="number">0</span>]) * (points[:, <span class="number">3</span>] - points[:, <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># warp points</span></span><br><span class="line">        xy = np.ones((n * <span class="number">4</span>, <span class="number">3</span>))</span><br><span class="line">        xy[:, :<span class="number">2</span>] = points[:, [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]].reshape(n * <span class="number">4</span>, <span class="number">2</span>)  <span class="comment"># x1y1, x2y2, x1y2, x2y1</span></span><br><span class="line">        xy = (xy @ M.T)[:, :<span class="number">2</span>].reshape(n, <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># create new boxes</span></span><br><span class="line">        x = xy[:, [<span class="number">0</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>]]</span><br><span class="line">        y = xy[:, [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>]]</span><br><span class="line">        xy = np.concatenate((x.<span class="built_in">min</span>(<span class="number">1</span>), y.<span class="built_in">min</span>(<span class="number">1</span>), x.<span class="built_in">max</span>(<span class="number">1</span>), y.<span class="built_in">max</span>(<span class="number">1</span>))).reshape(<span class="number">4</span>, n).T</span><br><span class="line"></span><br><span class="line">        <span class="comment"># # apply angle-based reduction of bounding boxes</span></span><br><span class="line">        <span class="comment"># radians = a * math.pi / 180</span></span><br><span class="line">        <span class="comment"># reduction = max(abs(math.sin(radians)), abs(math.cos(radians))) ** 0.5</span></span><br><span class="line">        <span class="comment"># x = (xy[:, 2] + xy[:, 0]) / 2</span></span><br><span class="line">        <span class="comment"># y = (xy[:, 3] + xy[:, 1]) / 2</span></span><br><span class="line">        <span class="comment"># w = (xy[:, 2] - xy[:, 0]) * reduction</span></span><br><span class="line">        <span class="comment"># h = (xy[:, 3] - xy[:, 1]) * reduction</span></span><br><span class="line">        <span class="comment"># xy = np.concatenate((x - w / 2, y - h / 2, x + w / 2, y + h / 2)).reshape(4, n).T</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># reject warped points outside of image</span></span><br><span class="line">        xy[:, [<span class="number">0</span>, <span class="number">2</span>]] = xy[:, [<span class="number">0</span>, <span class="number">2</span>]].clip(<span class="number">0</span>, width)</span><br><span class="line">        xy[:, [<span class="number">1</span>, <span class="number">3</span>]] = xy[:, [<span class="number">1</span>, <span class="number">3</span>]].clip(<span class="number">0</span>, height)</span><br><span class="line">        w = xy[:, <span class="number">2</span>] - xy[:, <span class="number">0</span>]</span><br><span class="line">        h = xy[:, <span class="number">3</span>] - xy[:, <span class="number">1</span>]</span><br><span class="line">        area = w * h</span><br><span class="line">        ar = np.maximum(w / (h + <span class="number">1e-16</span>), h / (w + <span class="number">1e-16</span>))</span><br><span class="line">        i = (w &gt; <span class="number">4</span>) &amp; (h &gt; <span class="number">4</span>) &amp; (area / (area0 + <span class="number">1e-16</span>) &gt; <span class="number">0.1</span>) &amp; (ar &lt; <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">        targets = targets[i]</span><br><span class="line">        targets[:, <span class="number">1</span>:<span class="number">5</span>] = xy[i]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> imw, targets</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convert_images2bmp</span>():</span></span><br><span class="line">    <span class="comment"># cv2.imread() jpg at 230 img/s, *.bmp at 400 img/s</span></span><br><span class="line">    <span class="keyword">for</span> path <span class="keyword">in</span> [<span class="string">&#x27;../coco/images/val2014/&#x27;</span>, <span class="string">&#x27;../coco/images/train2014/&#x27;</span>]:</span><br><span class="line">        folder = os.sep + Path(path).name</span><br><span class="line">        output = path.replace(folder, folder + <span class="string">&#x27;bmp&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(output):</span><br><span class="line">            shutil.rmtree(output)  <span class="comment"># delete output folder</span></span><br><span class="line">        os.makedirs(output)  <span class="comment"># make new output folder</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> f <span class="keyword">in</span> tqdm(glob.glob(<span class="string">&#x27;%s*.jpg&#x27;</span> % path)):</span><br><span class="line">            save_name = f.replace(<span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.bmp&#x27;</span>).replace(folder, folder + <span class="string">&#x27;bmp&#x27;</span>)</span><br><span class="line">            cv2.imwrite(save_name, cv2.imread(f))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> label_path <span class="keyword">in</span> [<span class="string">&#x27;../coco/trainvalno5k.txt&#x27;</span>, <span class="string">&#x27;../coco/5k.txt&#x27;</span>]:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(label_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">            lines = file.read()</span><br><span class="line">        lines = lines.replace(<span class="string">&#x27;2014/&#x27;</span>, <span class="string">&#x27;2014bmp/&#x27;</span>).replace(<span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.bmp&#x27;</span>).replace(</span><br><span class="line">            <span class="string">&#x27;/Users/glennjocher/PycharmProjects/&#x27;</span>, <span class="string">&#x27;../&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(label_path.replace(<span class="string">&#x27;5k&#x27;</span>, <span class="string">&#x27;5k_bmp&#x27;</span>), <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">            file.write(lines)</span><br></pre></td></tr></table></figure>
        </div>
        
<blockquote class="copyright">
    <p><strong>Link to this article : </strong><a class="permalink" href="http://yoursite.com/2020/02/04/deep_learning/yolo/yolov3%E4%BB%A3%E7%A0%81%E6%8E%A2%E7%A9%B6-4%20dataset.py/">http://yoursite.com/2020/02/04/deep_learning/yolo/yolov3代码探究-4 dataset.py/</a></p>
    <p><strong>This article is available under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)</a> License</strong></p>
</blockquote>


    </article>
    
    <section id="comments">
        
    </section>


    

</main>


<aside style="" id="sidebar" class="aside aside-fixture">
    <div class="toc-sidebar">
        <nav id="toc" class="article-toc">
            <h3 class="toc-title">Catalogue</h3>
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#yolov3%E4%BB%A3%E7%A0%81%E6%8E%A2%E7%A9%B6-4-dataset-py"><span class="toc-number">1.</span> <span class="toc-text">yolov3代码探究-4 dataset.py</span></a></li></ol>
        </nav>
    </div>
</aside>





        </section>
        <footer class="hidden lg:block fixed bottom-0 left-0 sm:w-1/12 lg:w-1/6 bg-gray-100 z-40">
    
    <div class="footer-social-links">
        
            <a target="_blank" rel="noopener" href="https://github.com/grac-gu">
                <i class="iconfont icon-github"></i>
            </a>
        
            <a href="/None">
                <i class="iconfont icon-telegram"></i>
            </a>
        
            <a href="/None">
                <i class="iconfont icon-twitter"></i>
            </a>
        
            <a href="/atom.xml">
                <i class="iconfont icon-rss"></i>
            </a>
        
    </div>
    
    
</footer>

        <div id="mask" class="hidden mask fixed inset-0 bg-gray-900 opacity-75 z-40"></div>
        <div id="search-view-container" class="hidden shadow-xl"></div>
        
<script src="/js/dom-event.min.js"></script>

<script src="//cdn.jsdelivr.net/npm/yox@1.0.0-alpha.121/dist/standard/prod/yox.min.js"></script>


<script src="/js/search.min.js"></script>



    <script src="//cdn.jsdelivr.net/npm/lightgallery.js@1.1.3/dist/js/lightgallery.min.js"></script>
    
<script src="/js/light-gallery.min.js"></script>





    </body>
</html>
